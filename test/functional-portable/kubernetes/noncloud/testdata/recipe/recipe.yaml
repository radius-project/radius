apiVersion: radapp.io/v1alpha3
kind: DeploymentTemplate
metadata:
  name: recipe.bicep
spec:
  parameters: {}
  providerConfig: |-
    {
      "radius": {
        "type": "radius",
        "value": {
          "scope": "/planes/radius/local/resourceGroups/default"
        }
      },
      "deployments": {
        "type": "Microsoft.Resources",
        "value": {
          "scope": "/planes/radius/local/resourceGroups/default"
        }
      }
    }
  template: |-
    {
      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
      "contentVersion": "1.0.0.0",
      "imports": {
        "Radius": {
          "provider": "Radius",
          "version": "latest"
        }
      },
      "languageVersion": "2.1-experimental",
      "metadata": {
        "_EXPERIMENTAL_FEATURES_ENABLED": [
          "Extensibility"
        ],
        "_EXPERIMENTAL_WARNING": "This template uses ARM features that are experimental. Experimental features should be enabled for testing purposes only, as there are no guarantees about the quality or stability of these features. Do not enable these settings for any production usage, or your production environment may be subject to breaking.",
        "_generator": {
          "name": "bicep",
          "templateHash": "7805117482855564",
          "version": "0.31.92.45157"
        }
      },
      "parameters": {
        "name": {
          "type": "string"
        },
        "namespace": {
          "type": "string"
        },
        "registry": {
          "type": "string"
        },
        "version": {
          "type": "string"
        }
      },
      "resources": {
        "app": {
          "dependsOn": [
            "env"
          ],
          "import": "Radius",
          "properties": {
            "name": "[format('{0}-app', parameters('name'))]",
            "properties": {
              "environment": "[reference('env').id]",
              "extensions": [
                {
                  "kind": "kubernetesNamespace",
                  "namespace": "[parameters('namespace')]"
                }
              ]
            }
          },
          "type": "Applications.Core/applications@2023-10-01-preview"
        },
        "env": {
          "import": "Radius",
          "properties": {
            "name": "[format('{0}-env', parameters('name'))]",
            "properties": {
              "compute": {
                "kind": "kubernetes",
                "namespace": "[format('{0}-env', parameters('name'))]",
                "resourceId": "self"
              },
              "recipes": {
                "Applications.Datastores/redisCaches": {
                  "default": {
                    "templateKind": "bicep",
                    "templatePath": "[format('{0}/test/testrecipes/test-bicep-recipes/redis-recipe-value-backed:{1}', parameters('registry'), parameters('version'))]"
                  }
                }
              }
            }
          },
          "type": "Applications.Core/environments@2023-10-01-preview"
        },
        "recipe": {
          "dependsOn": [
            "app",
            "env"
          ],
          "import": "Radius",
          "properties": {
            "name": "[format('{0}-recipe', parameters('name'))]",
            "properties": {
              "application": "[reference('app').id]",
              "environment": "[reference('env').id]"
            }
          },
          "type": "Applications.Datastores/redisCaches@2023-10-01-preview"
        }
      }
    }
