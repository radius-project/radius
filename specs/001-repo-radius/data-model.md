# Data Model: Repo Radius

**Feature**: 001-repo-radius | **Date**: 2026-02-02

This document defines the key entities, their fields, relationships, and validation rules for the Repo Radius feature.

---

## Terminology

| Term | Definition | Authored By |
|------|------------|-------------|
| **Application Model** | Bicep file defining the application (app.bicep) | Developer |
| **Application Resource** | Resource declared in the Application Model | Developer |
| **Cloud Resource** | Actual deployed infrastructure in Kubernetes, AWS, or Azure | Deployment Tool (Terraform/Bicep) |
| **Resource Type** | Schema definition for an Application Resource (e.g., `Radius.Data/postgreSqlDatabases`) | Radius + Platform Engineer |
| **Namespace** | Grouping for related Resource Types (e.g., `Radius.Data`, `Radius.Compute`) | Radius + Platform Engineer |
| **Recipe** | Mapping from a Resource Type to a deployment artifact (Terraform module or Bicep template) | Radius + Platform Engineer |
| **Deployment Tool** | The IaC tool that executes deployments (Terraform CLI or Bicep CLI) | N/A (installed by user) |
| **Deployment Step** | A single unit of work in the deployment plan; one Application Resource resolved to one Recipe execution | Radius (`rad plan`) |
| **Deployment Artifact** | Ready-to-execute IaC configuration generated by `rad plan` (e.g., `main.tf`, `main.bicep`) | Radius (`rad plan`) |
| **Deployment Record** | JSON file capturing deployment results after `rad deploy` completes; stored in `.radius/deploy/` | Radius (`rad deploy`) |
| **Application Environment** | A logical deployment stage for an application (e.g., `staging`, `production`). Configured via `.env` or `.env.<name>` files. Determines which cloud targets and settings to use. | Developer |
| **Cloud Environment** | A specific deployment target on a cloud platform (e.g., AWS account + region, Azure subscription + resource group, Kubernetes cluster + namespace). Defined within an Application Environment's `.env` file. | Platform Engineer |

> **Note**: Resource Types are organized by Namespaces (e.g., `Radius.Data`, `Radius.Compute`), not "Resource Providers". A Resource Type is identified by `{Namespace}/{TypeName}` (e.g., `Radius.Data/postgreSqlDatabases`).

> **Environment distinction**: An **Application Environment** (like `production`) may target multiple **Cloud Environments** (e.g., deploy containers to a Kubernetes cluster while provisioning databases in Azure). The `.env.production` file configures all cloud targets for that application environment.

**Key insight**: Application Resources are defined in the **Application Model** (`.radius/model/app.bicep`). Radius resolves each Application Resource to a Recipe, then orchestrates deployment to create Cloud Resources in Kubernetes, AWS, or Azure.

---

## Entity Definitions

### 1. Application Model

The Bicep file that defines the application's resources. This is the same format as today, just located in `.radius/model/`.

**Location**: `.radius/model/app.bicep` (or other `.bicep` files in that directory)

```bicep
// .radius/model/app.bicep
extension radius

param environment string

resource myApplication 'Radius.Core/applications@2025-08-01-preview' = {
  name: 'myapp'
  properties: {
    environment: environment
  }
}

resource frontend 'Radius.Compute/containers@2025-08-01-preview' = {
  name: 'frontend'
  properties: {
    environment: environment
    application: myApplication.id
    containers: {
      demo: {
        image: 'ghcr.io/radius-project/samples/demo:latest'
        ports: {
          web: {
            containerPort: 3000
          }
        }
      }
    }
    connections: {
      postgresql: {
        source: database.id
      }
    }
  }
}

resource database 'Radius.Data/postgreSqlDatabases@2025-08-01-preview' = {
  name: 'database'
  properties: {
    environment: environment
    application: myApplication.id
  }
}
```

Each resource in this file is an **Application Resource**. During `rad plan`, Radius:
1. Parses the Bicep model
2. Identifies each Application Resource and its Resource Type
3. Looks up the Recipe for that Resource Type in the recipe files configured for the target Environment
4. Generates ready-to-deploy Terraform or Bicep deployment artifacts

**Validation Rules**:
- File MUST be valid Bicep syntax
- All Resource Types MUST have corresponding Recipes defined
- Resource dependencies are inferred from Bicep references

---

### 2. Environment

Configuration for a deployment target. Stored as `.env` (default) or `.env.<name>` files.

```go
// pkg/cli/reporadius/config/environment.go

// Environment represents a deployment target configuration
type Environment struct {
    Name      string            // Derived from filename: "default" for .env, "production" for .env.production
    FilePath  string            // Absolute path to the .env file
    
    // Cloud Platform Configuration (mutually exclusive sets)
    AWS       *AWSConfig        // AWS deployment configuration
    Azure     *AzureConfig      // Azure deployment configuration
    
    // Kubernetes Configuration (optional, used when K8s is the container runtime)
    Kubernetes *KubernetesConfig
    
    // Recipe Configuration (required)
    Recipes []string            // Paths to recipe YAML files (from RECIPES env var)
    
    // Terraform Configuration (optional)
    TerraformCLIConfig string   // Path to terraformrc file (TF_CLI_CONFIG_FILE)
    TerraformBackend   string   // Path to backend config file (TF_BACKEND_CONFIG)
}

type AWSConfig struct {
    AccountID string  // AWS_ACCOUNT_ID (required for AWS deployments)
    Region    string  // AWS_REGION (required for AWS deployments)
}

type AzureConfig struct {
    SubscriptionID string  // AZURE_SUBSCRIPTION_ID (required for Azure deployments)
    ResourceGroup  string  // AZURE_RESOURCE_GROUP (required for Azure deployments)
}

type KubernetesConfig struct {
    Context   string  // KUBERNETES_CONTEXT (required when using K8s)
    Namespace string  // KUBERNETES_NAMESPACE (required when using K8s)
}
```

**Validation Rules**:
- `Recipes` MUST contain at least one path
- All paths in `Recipes` MUST exist and be valid YAML files
- If `AWS` is set, both `AccountID` and `Region` MUST be non-empty
- If `Azure` is set, both `SubscriptionID` and `ResourceGroup` MUST be non-empty
- If `Kubernetes` is set, both `Context` and `Namespace` MUST be non-empty
- File MUST NOT contain credential patterns (warning issued)

**Example `.env` (default environment)**:
```bash
# Cloud Platform - AWS
AWS_ACCOUNT_ID=123456789012
AWS_REGION=us-west-2

# Kubernetes Runtime
KUBERNETES_CONTEXT=my-eks-cluster
KUBERNETES_NAMESPACE=my-app

# Recipe Configuration (required)
RECIPES=.radius/config/recipes/aws.yaml,.radius/config/recipes/custom.yaml

# Terraform Configuration (optional)
TF_CLI_CONFIG_FILE=~/.terraformrc
TF_BACKEND_CONFIG=.radius/config/backend-s3.hcl
```

**Example `.env.production`**:
```bash
# Cloud Platform - Azure
AZURE_SUBSCRIPTION_ID=12345678-1234-1234-1234-123456789012
AZURE_RESOURCE_GROUP=my-app-prod-rg

# Kubernetes Runtime
KUBERNETES_CONTEXT=aks-prod-cluster
KUBERNETES_NAMESPACE=my-app-prod

# Recipe Configuration
RECIPES=.radius/config/recipes/azure.yaml

# Terraform Backend for Production
TF_BACKEND_CONFIG=.radius/config/backend-azurerm.hcl
```

---

### 2. Workspace

Configuration determining how `rad` commands execute. Stored in `~/.rad/config.yaml`.

```go
// pkg/cli/workspaces/git.go

// GitWorkspace represents the built-in Git workspace for Repo Radius mode
type GitWorkspace struct {
    // GitWorkspace is built-in and has no configurable fields
    // It operates on the current Git repository
}

// Implements workspaces.Workspace interface
func (g *GitWorkspace) GetConnection() Connection {
    return &GitConnection{Kind: "git"}
}

func (g *GitWorkspace) IsBuiltIn() bool {
    return true
}

// GitConnection is the connection type for Git workspace
type GitConnection struct {
    Kind string `yaml:"kind"` // Always "git"
}
```

**Example `~/.rad/config.yaml`**:
```yaml
# Radius CLI configuration file
# Location: ~/.rad/config.yaml

# Current workspace - used when no --workspace flag is provided
current: git

# Workspace definitions
workspaces:
  # Built-in Git workspace for Repo Radius mode (local/decentralized)
  git:
    connection:
      kind: git
  
  # Control Plane workspace example (centralized mode)
  dev-cluster:
    connection:
      kind: kubernetes
      context: my-dev-cluster
    scope: /planes/radius/local/resourceGroups/my-app
    environment: /planes/radius/local/resourceGroups/my-app/providers/Applications.Core/environments/dev
```

**State Transitions**:
- `git` ↔ `<control-plane-workspace>` via `rad workspace switch`
- Default workspace after installation: `git`

---

### 3. Recipes

> **Terminology Note**: In Control Plane Radius, recipes are managed via "Recipe Pack" resources with full metadata. In Repo Radius, we use the simpler term "recipes" since they're just YAML files containing recipe mappings. The `RECIPES` environment variable replaces what would be `RECIPE_PACKS` in Control Plane terminology.

A recipes file contains mappings from Resource Types to deployment artifacts. Multiple recipe files can exist in `.radius/config/recipes/` and are referenced via the `RECIPES` environment variable.

**Location**: `.radius/config/recipes/*.yaml` (e.g., `aws.yaml`, `azure.yaml`, `custom.yaml`)

```go
// pkg/cli/git/config/recipes.go

// RecipeFile represents a .radius/config/recipes/*.yaml file
type RecipeFile struct {
    Name    string   `yaml:"name"`    // File identifier (e.g., "aws-default", "custom")
    Recipes []Recipe `yaml:"recipes"` // Recipe definitions in this file
}

// Recipe maps a resource type to its deployment artifact
type Recipe struct {
    ResourceType   string `yaml:"resourceType"`   // e.g., "Applications.Datastores/redisCaches"
    RecipeKind     string `yaml:"recipeKind"`     // "terraform" or "bicep"
    RecipeLocation string `yaml:"recipeLocation"` // OCI ref, git URL, or file path
}
```

**Example** (`.radius/config/recipes/aws.yaml`):
```yaml
name: aws-default
recipes:
  - resourceType: Applications.Datastores/redisCaches
    recipeKind: terraform
    recipeLocation: git::https://github.com/radius-project/recipes.git//aws/redis?ref=v1.0.0
  - resourceType: Applications.Datastores/sqlDatabases
    recipeKind: terraform
    recipeLocation: git::https://github.com/radius-project/recipes.git//aws/rds?ref=v1.0.0
```

**Multiple Recipe Files**:
```
.radius/config/recipes/
├── aws.yaml       # AWS-specific recipes
├── azure.yaml     # Azure-specific recipes
└── custom.yaml    # Team's custom recipes
```

Referenced in `.env`:
```
RECIPES=.radius/config/recipes/aws.yaml,.radius/config/recipes/custom.yaml
```

**Validation Rules**:
- `Name` MUST be unique across all loaded recipe files
- `ResourceType` MUST match pattern `<Provider>.<Category>/<type>` (e.g., `Applications.Datastores/redisCaches`)
- `RecipeKind` MUST be one of: `terraform`, `bicep`
- `RecipeLocation` MUST be a valid:
  - Git URL with ref: `git::https://github.com/org/repo.git//path?ref=v1.0.0`
  - OCI reference: `br:registry.azurecr.io/recipes/name:version`
  - File path: `./local/path/to/module`
- For `terraform`: location MUST be pinned (git ref or specific version) unless `--allow-unpinned-recipes` flag
- For `bicep`: location MUST NOT use `latest` tag unless `--allow-unpinned-recipes` flag
- If same `ResourceType` appears in multiple files, **last one wins** (order determined by `RECIPES`)

---

### 4. DeploymentStep

A single step in the deployment sequence generated by `rad plan`. Each step corresponds to one Application Resource from the Bicep model, resolved to its Recipe.

```go
// pkg/cli/reporadius/deploy/step.go

// DeploymentStep represents one step in the deployment plan
// Each step corresponds to one Application Resource from the Bicep model
type DeploymentStep struct {
    Sequence               int           // Order of execution (1, 2, 3, ...)
    ApplicationResourceName string       // Resource name from Bicep model (e.g., "redis", "container")
    ResourceType           string        // e.g., "Applications.Datastores/redisCaches"
    Tool                   DeployTool    // terraform or bicep (determined by Recipe)
    Directory              string        // e.g., ".radius/plan/001-redis-terraform/"
    DependsOn              []string      // Other resources this depends on (inferred from Bicep)
}

type DeployTool string

const (
    DeployToolTerraform DeployTool = "terraform"
    DeployToolBicep     DeployTool = "bicep"
)

// Plan represents the plan.yaml file generated by `rad plan`
type Plan struct {
    GeneratedAt    time.Time        `yaml:"generatedAt"`
    Environment    string           `yaml:"environment"`
    Commit         string           `yaml:"commit,omitempty"`
    Steps          []DeploymentStep `yaml:"steps"`
    RecipeVersions []RecipeVersion  `yaml:"recipeVersions"` // For change detection
}

type RecipeVersion struct {
    ResourceType string `yaml:"resourceType"`
    Location     string `yaml:"location"`
    Version      string `yaml:"version"` // Extracted from location (git ref or OCI tag)
}
```

**Directory Structure for Each Step**:

Terraform step example:
```
.radius/plan/<app>/<env>/001-network-terraform/
├── main.tf                  # Generated Terraform config
├── terraform.tfvars         # Variable values from model/env
├── terraform-plan.txt       # Output of terraform plan
├── terraform.lock.hcl       # Provider lock file
└── terraform-context.log    # Execution context for audit
```

Bicep step example:
```
.radius/plan/<app>/<env>/002-database-bicep/
├── database.bicep           # Generated Bicep template
├── database.bicepparam      # Parameter values from model/env
├── bicep-whatif.txt         # Output of az deployment what-if
└── bicep-context.log        # Execution context for audit
```

---

### 5. DeploymentRecord

Structured details captured after `rad deploy` completes. Tracks both Application Resources (what Radius orchestrated) and Cloud Resources (what Terraform/Bicep deployed).

```go
// pkg/cli/reporadius/record/record.go

// DeploymentRecord is stored in .radius/deploy/<app>/<env>/deployment-<commit>.json
type DeploymentRecord struct {
    Deployment           DeploymentMetadata          `json:"deployment"`
    ApplicationResources []ApplicationResourceResult `json:"applicationResources"` // What Radius orchestrated
    CloudResources       []CloudResource             `json:"cloudResources"`       // What Terraform/Bicep deployed
    Status               DeploymentStatus            `json:"status"`
}

type DeploymentMetadata struct {
    Application string    `json:"application"`
    Commit      string    `json:"commit"`
    Timestamp   time.Time `json:"timestamp"`
    Environment string    `json:"environment"`
    Duration    string    `json:"duration,omitempty"` // e.g., "2m 34s"
}

// ApplicationResourceResult tracks Radius-level orchestration results
type ApplicationResourceResult struct {
    Name     string           `json:"name"`     // From radius.yaml
    Type     string           `json:"type"`     // "terraform" or "bicep"
    Status   DeploymentStatus `json:"status"`   // success, failed
    Duration string           `json:"duration"` // How long this resource took
    Error    string           `json:"error,omitempty"`
}

// CloudResource represents actual deployed infrastructure (from Terraform state / ARM)
type CloudResource struct {
    ID                      string                 `json:"id"`                      // ARM ID, ARN, K8s UID
    Type                    string                 `json:"type"`                    // ARM type, AWS type, K8s kind
    Name                    string                 `json:"name"`                    
    ApplicationResourceName string                 `json:"applicationResourceName"` // Which ApplicationResource created this
    Properties              map[string]interface{} `json:"properties,omitempty"`    // Optional: resource snapshot
}

type DeploymentStatus string

const (
    StatusSuccess       DeploymentStatus = "success"
    StatusPartialFailed DeploymentStatus = "partial_failed"  // Some ApplicationResources failed
    StatusFailed        DeploymentStatus = "failed"
)
```

**File Location**: `.radius/deploy/<application>/<environment>/deployment-<commit-short>.json`

**Retention**: All records retained indefinitely (no automatic cleanup)

---

### 6. Resource Type

> **Terminology Clarification**: Radius uses "Resource Type" (not "Resource Provider") to avoid confusion with cloud providers like Azure or AWS. Resource Types are grouped by namespace (e.g., `Radius.Data`, `Radius.Compute`). The fully qualified name is `{Namespace}/{TypeName}` (e.g., `Radius.Data/postgreSqlDatabases`).

Resource Type definitions are stored as YAML files in `.radius/config/types/`. Each file defines a namespace and the Resource Types within it. This matches the format used by `rad resource-type create`.

```go
// pkg/cli/git/config/resourcetype.go
// Reuses pkg/cli/manifest types for compatibility

// ResourceTypeFile represents a .radius/config/types/*.yaml file
// Contains a namespace and its Resource Type definitions
type ResourceTypeFile struct {
    // Namespace groups related Resource Types (e.g., "Radius.Compute", "Radius.Data")
    // Format: PascalCase.PascalCase
    Namespace string `yaml:"namespace" validate:"required"`
    
    // Types maps Resource Type names to their definitions
    // Keys are camelCased (e.g., "containers", "postgreSqlDatabases")
    Types map[string]*ResourceType `yaml:"types" validate:"required"`
}

// ResourceType defines a single Resource Type's schema and capabilities
type ResourceType struct {
    // Capabilities for the resource type (e.g., "Recipes", "ManualProvisioning")
    Capabilities []string `yaml:"capabilities"`
    
    // DefaultAPIVersion is the default API version (e.g., "2025-01-01-preview")
    DefaultAPIVersion *string `yaml:"defaultApiVersion,omitempty"`
    
    // APIVersions maps version strings to their schemas
    APIVersions map[string]*ResourceTypeAPIVersion `yaml:"apiVersions" validate:"required"`
    
    // Description of the resource type
    Description *string `yaml:"description,omitempty"`
}

// ResourceTypeAPIVersion contains the schema for a specific API version
type ResourceTypeAPIVersion struct {
    // Schema is the OpenAPI schema for the resource type
    Schema any `yaml:"schema" validate:"required"`
}
```

**Fully Qualified Resource Type Name**: `{Namespace}/{TypeName}@{APIVersion}`
- Example: `Radius.Data/postgreSqlDatabases@2025-01-01-preview`
- Namespace: `Radius.Data`
- Type Name: `postgreSqlDatabases`
- API Version: `2025-01-01-preview`

**Validation Rules**:
- `Namespace` MUST match pattern `^[A-Z][A-Za-z0-9]+\.[A-Z][A-Za-z0-9]+$` (e.g., `Radius.Data`)
- Type name keys MUST match pattern `^[a-z][A-Za-z0-9]+$` (camelCase, e.g., `postgreSqlDatabases`)
- `APIVersion` keys MUST match pattern `^\d{4}-\d{2}-\d{2}(-preview)?$` (e.g., `2025-01-01-preview`)
- `Capability` values MUST match pattern `^[A-Z][A-Za-z0-9]+$` (PascalCase)
- `Schema` MUST be valid OpenAPI schema

**Example** (`.radius/config/types/radius-data.yaml`):
```yaml
namespace: Radius.Data
types:
  postgreSqlDatabases:
    description: PostgreSQL database resource
    defaultApiVersion: "2025-01-01-preview"
    capabilities:
      - Recipes
    apiVersions:
      "2025-01-01-preview":
        schema:
          type: object
          properties:
            database:
              type: string
            port:
              type: integer
              default: 5432
```

**Source**: Fetched from `radius-project/resource-types-contrib` via git sparse-checkout during `rad init`.

---

## Entity Relationships

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           ~/.rad/config.yaml                             │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                         Workspace                                    │ │
│  │  • current: "git" | "<control-plane-name>"                          │ │
│  │  • items: map of workspace configurations                           │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ determines execution mode
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                           Git Repository                                 │
│                                                                          │
│  .radius/model/app.bicep ────────────────► Application Model (Bicep)    │
│       │                                           │                      │
│       │                                           │ defines Application  │
│       │                                           │ Resources            │
│       │                                           ▼                      │
│  .env, .env.<name>  ──────────────────────► Environment                 │
│       │                                           │                      │
│       │ references                                │ references           │
│       ▼                                           ▼                      │
│  .radius/config/recipes/*.yaml ──────────► Recipe Files (1..n)          │
│       │                                           │                      │
│       │                                           │ contains Recipes     │
│       │                                           │ mapping Resource     │
│       │                                           │ Types to deployments │
│       │                                           ▼                      │
│  .radius/config/types/*.yaml ────────────► Resource Types (1..n)        │
│                                                                          │
│       │ rad plan (resolves Application Resources to Recipes)             │
│       ▼                                                                  │
│  .radius/plan/                                                           │
│       │  plan.yaml ──────────────────────► Plan                         │
│       │  001-redis-terraform/    ────────► DeploymentStep               │
│       │  002-container-bicep/              (one per Application Resource)│
│       │                                                                  │
│       │ rad deploy (orchestrates in dependency order)                    │
│       ▼                                                                  │
│  .radius/deploy/                                                         │
│       └─ <app>/<env>/deployment-<commit>.json ► DeploymentRecord        │
│                                                   │                      │
│                                   ┌───────────────┴───────────────┐      │
│                                   ▼                               ▼      │
│                       ApplicationResourceResult        CloudResource     │
│                       (what Radius orchestrated)    (what TF/Bicep made) │
└──────────────────────────────────────────────────────────────────────────┘
```

## State Transitions

### Deployment Lifecycle

```
                    ┌─────────────────┐
                    │   Not Deployed  │
                    └────────┬────────┘
                             │ rad plan
                             ▼
                    ┌─────────────────┐
                    │    Planned      │
                    │ (.radius/plan/) │
                    └────────┬────────┘
                             │ git commit
                             ▼
                    ┌─────────────────┐
                    │   Committed     │
                    └────────┬────────┘
                             │ rad deploy --commit
                             ▼
              ┌──────────────┴──────────────┐
              ▼                             ▼
     ┌─────────────────┐          ┌─────────────────┐
     │    Deployed     │          │  Deploy Failed  │
     │   (success)     │          │ (partial state) │
     └─────────────────┘          └────────┬────────┘
                                           │
                                           │ User fixes issue,
                                           │ re-runs rad deploy
                                           │ (idempotent)
                                           ▼
                                  ┌─────────────────┐
                                  │    Deployed     │
                                  │   (success)     │
                                  └─────────────────┘

Note: No automatic rollback. Terraform/Bicep handle idempotent convergence.
      On failure, user fixes and re-runs. For teardown, use `rad delete`.
```

### Workspace Switching

```
     ┌─────────────┐                    ┌─────────────────────┐
     │     git     │◄──────────────────►│ Control Plane WS    │
     │ (built-in)  │  rad workspace     │ (user-created)      │
     │             │     switch         │                     │
     └─────────────┘                    └─────────────────────┘
           │                                     │
           │ rad deploy                          │ rad deploy
           ▼                                     ▼
     ┌─────────────┐                    ┌─────────────────────┐
     │   Execute   │                    │   Submit to         │
     │   Locally   │                    │   Control Plane     │
     └─────────────┘                    └─────────────────────┘
```
