suite: test terraform configuration
templates:
  - rp/deployment.yaml
  - rp/configmaps.yaml
  - dynamic-rp/deployment.yaml
  - terraform-pvc.yaml
tests:
  # Terraform PVC tests
  - it: should create terraform PVC when terraform is enabled
    set:
      global.terraform.enabled: true
    asserts:
      - isKind:
          of: PersistentVolumeClaim
        template: terraform-pvc.yaml
      - equal:
          path: metadata.name
          value: terraform-storage
        template: terraform-pvc.yaml
      - contains:
          path: spec.accessModes
          content: ReadWriteMany
        template: terraform-pvc.yaml

  - it: should use custom storage class when specified
    set:
      global.terraform.enabled: true
      global.terraform.storageClassName: "nfs"
    asserts:
      - equal:
          path: spec.storageClassName
          value: "nfs"
        template: terraform-pvc.yaml

  - it: should use custom storage size when specified
    set:
      global.terraform.enabled: true
      global.terraform.storageSize: "5Gi"
    asserts:
      - equal:
          path: spec.resources.requests.storage
          value: "5Gi"
        template: terraform-pvc.yaml

  # applications-rp terraform volume tests
  - it: should use PVC for terraform volume in applications-rp when terraform is enabled
    set:
      global.terraform.enabled: true
      rp.image: applications-rp
      rp.tag: latest
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: terraform
            persistentVolumeClaim:
              claimName: terraform-storage
        template: rp/deployment.yaml

  - it: should mount terraform volume in applications-rp container
    set:
      global.terraform.enabled: true
      rp.image: applications-rp
      rp.tag: latest
      rp.terraform.path: /terraform
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: terraform
            mountPath: /terraform
        template: rp/deployment.yaml

  - it: should include terraform init container when terraform is enabled
    set:
      global.terraform.enabled: true
      rp.image: applications-rp
      rp.tag: latest
    asserts:
      - isNotEmpty:
          path: spec.template.spec.initContainers
        template: rp/deployment.yaml
      - contains:
          path: spec.template.spec.initContainers
          content:
            name: terraform-init
          any: true
        template: rp/deployment.yaml

  - it: should include terraform config in applications-rp configmap
    asserts:
      - matchRegex:
          path: data["radius-self-host.yaml"]
          pattern: "terraform:\\s+path: \"/terraform\""
        template: rp/configmaps.yaml

  # dynamic-rp terraform volume tests
  - it: should use PVC for terraform volume in dynamic-rp when terraform is enabled
    set:
      global.terraform.enabled: true
      dynamicrp.image: dynamic-rp
      dynamicrp.tag: latest
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: terraform
            persistentVolumeClaim:
              claimName: terraform-storage
        template: dynamic-rp/deployment.yaml

  - it: should mount terraform volume in dynamic-rp container
    set:
      global.terraform.enabled: true
      dynamicrp.image: dynamic-rp
      dynamicrp.tag: latest
      dynamicrp.terraform.path: /terraform
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: terraform
            mountPath: /terraform
        template: dynamic-rp/deployment.yaml

  - it: should include terraform init container in dynamic-rp when terraform is enabled
    set:
      global.terraform.enabled: true
      dynamicrp.image: dynamic-rp
      dynamicrp.tag: latest
    asserts:
      - isNotEmpty:
          path: spec.template.spec.initContainers
        template: dynamic-rp/deployment.yaml
      - contains:
          path: spec.template.spec.initContainers
          content:
            name: terraform-init
          any: true
        template: dynamic-rp/deployment.yaml

  # Both deployments use the same shared PVC
  - it: should use shared PVC for both deployments
    set:
      global.terraform.enabled: true
      rp.image: applications-rp
      rp.tag: latest
      dynamicrp.image: dynamic-rp
      dynamicrp.tag: latest
    asserts:
      # applications-rp uses shared PVC
      - contains:
          path: spec.template.spec.volumes
          content:
            name: terraform
            persistentVolumeClaim:
              claimName: terraform-storage
        template: rp/deployment.yaml
      # dynamic-rp uses same shared PVC
      - contains:
          path: spec.template.spec.volumes
          content:
            name: terraform
            persistentVolumeClaim:
              claimName: terraform-storage
        template: dynamic-rp/deployment.yaml
