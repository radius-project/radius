{{- $encryptionKey := randBytes 32 }}
{{- $now := now }}
{{- $expiry := dateModify "2160h" $now }}  {{/* 90 days from now */}}
{{- $keyStoreJson := dict "currentVersion" 1 "keys" (dict "1" (dict "key" ($encryptionKey | b64enc) "version" 1 "createdAt" ($now | date "2006-01-02T15:04:05Z07:00") "expiresAt" ($expiry | date "2006-01-02T15:04:05Z07:00"))) | toJson }}
apiVersion: v1
kind: Secret
metadata:
  name: radius-encryption-key
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: dynamic-rp
    app.kubernetes.io/part-of: radius
  annotations:
    radius.dev/last-rotation: {{ $now | date "2006-01-02T15:04:05Z07:00" | quote }}
type: Opaque
data:
  keys.json: {{ include "secrets.lookup" (dict "secret" "radius-encryption-key" "namespace" .Release.Namespace "key" "keys.json" "defaultValue" $keyStoreJson) | quote }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: radius-encryption-key-role
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: dynamic-rp
    app.kubernetes.io/part-of: radius
rules:
- apiGroups:
  - ""
  resources:
  - secrets
  resourceNames:
  - radius-encryption-key
  verbs:
  - get
  - update
  - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: radius-encryption-key-rolebinding
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/name: dynamic-rp
    app.kubernetes.io/part-of: radius
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: radius-encryption-key-role
subjects:
- kind: ServiceAccount
  name: dynamic-rp
  namespace: {{ .Release.Namespace }}
- kind: ServiceAccount
  name: ucp
  namespace: {{ .Release.Namespace }}
