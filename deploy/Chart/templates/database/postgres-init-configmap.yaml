apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: {{ .Release.Namespace }}
  labels:
    control-plane: database
    app.kubernetes.io/name: database
    app.kubernetes.io/part-of: radius
data:
   # Single combined SQL initialization file
  init-db.sql: |
    -- PostgreSQL Initialization SQL
    -- This file combines the functionality of init-db.sh and db.sql.txt

    -- Create users and databases for resource providers
    CREATE USER ucp WITH PASSWORD 'postgres_password';
    CREATE DATABASE ucp;
    GRANT ALL PRIVILEGES ON DATABASE ucp TO ucp;

    CREATE USER applications_rp WITH PASSWORD 'postgres_password';
    CREATE DATABASE applications_rp;
    GRANT ALL PRIVILEGES ON DATABASE applications_rp TO applications_rp;

    -- Connect to the ucp database to create tables
    \connect ucp

    -- Create 'resources' table in ucp database
    CREATE TABLE resources (
        -- resource id used as key.
        id TEXT PRIMARY KEY NOT NULL,

        -- original_id is used to store the original id of the resource before any normalization occurs.
        original_id TEXT NOT NULL,

        -- resource type by queries to filter by type.
        resource_type TEXT NOT NULL,

        -- root_scope used by queries to list resources by their scope.
        root_scope TEXT NOT NULL,

        -- routing_scope used by queries to list resources when they are child resources.
        routing_scope TEXT NOT NULL,
        
        -- etag used for optimistic concurrency control.
        etag TEXT NOT NULL,

        -- timestamp is used to implement cursor-based pagination
        created_at TIMESTAMP (6) WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

        -- resource_data stores the resource data.
        resource_data JSONB NOT NULL
    );

    -- Create index for optimal querying in ucp database
    CREATE INDEX idx_resource_query ON resources (resource_type, root_scope);

    -- Connect to the applications_rp database to create tables
    \connect applications_rp

    -- Create the same resources table in applications_rp database
    CREATE TABLE resources (
        -- resource id used as key.
        id TEXT PRIMARY KEY NOT NULL,

        -- original_id is used to store the original id of the resource before any normalization occurs.
        original_id TEXT NOT NULL,

        -- resource type by queries to filter by type.
        resource_type TEXT NOT NULL,

        -- root_scope used by queries to list resources by their scope.
        root_scope TEXT NOT NULL,

        -- routing_scope used by queries to list resources when they are child resources.
        routing_scope TEXT NOT NULL,
        
        -- etag used for optimistic concurrency control.
        etag TEXT NOT NULL,

        -- timestamp is used to implement cursor-based pagination
        created_at TIMESTAMP (6) WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

        -- resource_data stores the resource data.
        resource_data JSONB NOT NULL
    );

    -- Create index for optimal querying in applications_rp database
    CREATE INDEX idx_resource_query ON resources (resource_type, root_scope);