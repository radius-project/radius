{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.1",
    "parameters": {
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Location for all resources."
            }
        },
        "servicePrincipalClientId": {
            "defaultValue": "",
            "metadata": {
                "description": "The Service Principal Client Id."
            },
            "type": "securestring"
        },
        "servicePrincipalClientSecret": {
            "defaultValue": "",
            "metadata": {
                "description": "The Service Principal Client Secret."
            },
            "type": "securestring"
        },
        "_scriptUri": {
            "type": "string",
            "defaultValue": "https://radiuspublic.blob.core.windows.net/environment/initialize-cluster.sh",
            "metadata": {
                "description": "URI of the script to execute. Used for testing."
            }
        },
        "image": {
            "type": "string",
            "defaultValue": "radiusteam/radiusrp:latest",
            "metadata": {
                "description": "The container image to deploy."
            }
        },
        "siteName": {
            "type": "string",
            "defaultValue": "[concat('radius-rp-', uniqueString(resourceGroup().id))]",
            "metadata": {
                "description": "The name of your Web Site."
            }
        },
        "accountName": {
            "type": "string",
            "defaultValue": "[concat('radius-rp-', uniquestring(resourceGroup().id))]",
            "metadata": {
                "description": "The unique name of the cosmos db account."
            }
        },
        "databaseName": {
            "type": "string",
            "defaultValue": "radius-rp-db",
            "metadata": {
                "description": "The database name."
            }
        },
        "clusterName": {
            "type": "string",
            "defaultValue": "[concat('radius-aks-', uniqueString(resourceGroup().id))]",
            "metadata": {
                "description": "The name of the Managed Cluster resource."
            }
        },
        "sku": {
            "type": "string",
            "allowedValues": [
                "B1",
                "B2",
                "B3",
                "S1",
                "S2",
                "S3",
                "P1",
                "P2",
                "P3",
                "P4"
            ],
            "defaultValue": "B1",
            "metadata": {
                "description": "The pricing tier for the hosting plan."
            }
        },
        "workerSize": {
            "type": "string",
            "allowedValues": [
                "0",
                "1",
                "2"
            ],
            "defaultValue": "0",
            "metadata": {
                "description": "The instance size of the hosting plan (small, medium, or large)."
            }
        },
        "kubernetesVersion": {
            "type": "string",
            "defaultValue": "1.18.14",
            "metadata": {
                "description": "The version of Kubernetes to use."
            }
        },
        "osDiskSizeGB": {
            "type": "int",
            "defaultValue": 0,
            "metadata": {
                "description": "Disk size (in GB) to provision for each of the agent pool nodes. This value ranges from 0 to 1023. Specifying 0 will apply the default disk size for that agentVMSize."
            },
            "minValue": 0,
            "maxValue": 1023
        },
        "agentCount": {
            "type": "int",
            "defaultValue": 3,
            "metadata": {
                "description": "The number of nodes for the cluster."
            },
            "minValue": 1,
            "maxValue": 50
        },
        "agentVMSize": {
            "type": "string",
            "defaultValue": "Standard_DS2_v2",
            "metadata": {
                "description": "The size of the Virtual Machine."
            }
        },
        "linuxAdminUsername": {
            "type": "string",
            "defaultValue": "azureuser",
            "metadata": {
                "description": "User name for the Linux Virtual Machines."
            }
        },
        "sshRSAPublicKey": {
            "type": "string",
            "metadata": {
                "description": "Configure all linux machines with the SSH RSA public key string. Your key should include three parts, for example 'ssh-rsa AAAAB...snip...UcyupgH azureuser@linuxvm'"
            }
        },
        "osType": {
            "type": "string",
            "defaultValue": "Linux",
            "allowedValues": [
                "Linux"
            ],
            "metadata": {
                "description": "The type of operating system."
            }
        },
        "identityName": {
            "type": "string",
            "defaultValue": "[concat('radius-deployment-id-', uniqueString(resourceGroup().id))]",
            "metadata": {
                "description": "The identity name to use for the deployment script."
            }
        }
    },
    "variables": {
        "hostingPlanName": "[concat('radius-rp-plan-', resourceGroup().name)]",
        "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
        "roleDefinitionName": "[guid(parameters('identityName'), subscription().subscriptionId)]"
    },
    "resources": [
        {
            "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
            "name": "[parameters('identityName')]",
            "apiVersion": "2018-11-30",
            "location": "[resourceGroup().location]"
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2019-04-01-preview",
            "name": "[variables('roleDefinitionName')]",
            "dependsOn": [
                "[parameters('identityName')]"
            ],
            "properties": {
                "roleDefinitionId": "[variables('roleDefinitionId')]",
                "principalId": "[reference(parameters('identityName')).principalId]",
                "scope": "[resourceGroup().id]",
                "principalType": "ServicePrincipal"
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts",
            "name": "[parameters('accountName')]",
            "apiVersion": "2020-03-01",
            "location": "[parameters('location')]",
            "kind": "MongoDB",
            "properties": {
                "locations": [
                    {
                        "locationName": "[parameters('location')]",
                        "failoverPriority": 0,
                        "isZoneRedundant": false
                    }
                ],
                "databaseAccountOfferType": "Standard",
                "apiProperties": {
                    "serverVersion": "3.6"
                }
            }
        },
        {
            "type": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases",
            "name": "[concat(parameters('accountName'), '/', parameters('databaseName'))]",
            "apiVersion": "2020-03-01",
            "dependsOn": [ "[resourceId('Microsoft.DocumentDB/databaseAccounts/', parameters('accountName'))]" ],
            "properties": {
                "resource": {
                    "id": "[parameters('databaseName')]"
                },
                "options": { "throughput": "400" }
            }
        },
        {
            "type": "Microsoft.DocumentDb/databaseAccounts/mongodbDatabases/collections",
            "name": "[concat(parameters('accountName'), '/', parameters('databaseName'), '/', 'applications')]",
            "apiVersion": "2020-03-01",
            "dependsOn": [ "[resourceId('Microsoft.DocumentDB/databaseAccounts/mongodbDatabases', parameters('accountName'), parameters('databaseName'))]" ],
            "properties": {
                "resource": {
                    "id": "applications",
                    "shardKey": { "subscriptionId": "Hash" },
                    "indexes": [],
                    "options": {
                        "If-Match": "<ETag>"
                    }
                },
                "options": {}
            }
        },
        {
            "apiVersion": "2020-03-01",
            "type": "Microsoft.ContainerService/managedClusters",
            "location": "[parameters('location')]",
            "name": "[parameters('clusterName')]",
            "tags": {
                "rad-environment": "true"
            },
            "properties": {
                "kubernetesVersion": "[parameters('kubernetesVersion')]",
                "dnsPrefix": "[parameters('clusterName')]",
                "agentPoolProfiles": [
                    {
                        "name": "agentpool",
                        "osDiskSizeGB": "[parameters('osDiskSizeGB')]",
                        "count": "[parameters('agentCount')]",
                        "vmSize": "[parameters('agentVMSize')]",
                        "osType": "[parameters('osType')]",
                        "storageProfile": "ManagedDisks"
                    }
                ],
                "linuxProfile": {
                    "adminUsername": "[parameters('linuxAdminUsername')]",
                    "ssh": {
                        "publicKeys": [
                            {
                                "keyData": "[parameters('sshRSAPublicKey')]"
                            }
                        ]
                    }
                },
                "servicePrincipalProfile": {
                    "clientId": "[parameters('servicePrincipalClientId')]",
                    "Secret": "[parameters('servicePrincipalClientSecret')]"
                },
                "enableRBAC": true
            }
        },
        {
            "type": "Microsoft.Resources/deploymentScripts",
            "apiVersion": "2019-10-01-preview",
            "name": "deploy-radius-runtime",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "[resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName'))]",
                "[resourceId('Microsoft.Authorization/roleAssignments', variables('roleDefinitionName'))]"
            ],
            "kind": "AzureCLI",
            "identity": {
                "type": "userAssigned",
                "userAssignedIdentities": {
                    "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('identityName'))]": {}
                }
            },
            "properties": {
                "forceUpdateTag": 1,
                "azCliVersion": "2.0.80",
                "arguments": "[concat('\"', resourceGroup().name, '\" \"', parameters('clusterName'), '\"')]",
                "primaryScriptUri": "[parameters('_scriptUri')]",
                "supportingScriptUris": [],
                "timeout": "PT30M",
                "cleanupPreference": "OnSuccess",
                "retentionInterval": "P1D"
            }
        },
        {
            "type": "Microsoft.Web/serverfarms",
            "apiVersion": "2018-02-01",
            "name": "[variables('hostingPlanName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "[parameters('sku')]",
                "capacity": "[parameters('workerSize')]"
            },
            "kind": "linux",
            "properties": {
                "name": "[variables('hostingPlanName')]",
                "reserved": true
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2020-06-01",
            "name": "[parameters('siteName')]",
            "location": "[parameters('location')]",
            "identity": {
                "type": "None"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('hostingPlanName'))]",
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/mongodbDatabases', parameters('accountName'), parameters('databaseName'))]",
                "[resourceId('Microsoft.ContainerService/managedClusters', parameters('clusterName'))]",
                "[resourceId('Microsoft.Resources/deploymentScripts', 'deploy-radius-runtime')]"
            ],
            "kind": "app,linux,container",
            "properties": {
                "serverFarmId": "[variables('hostingPlanName')]",
                "clientCertEnabled": true,
                "clientCertMode": "Optional",
                "siteConfig": {
                    "linuxFxVersion": "[concat('DOCKER|', parameters('image'))]",
                    "appSettings": [
                        {
                            "name": "MONGODB_CONNECTION_STRING",
                            "value": "[listConnectionStrings(resourceId('Microsoft.DocumentDb/databaseAccounts', parameters('accountName')), '2020-04-01').connectionStrings[0].connectionString]"
                        },
                        {
                            "name": "MONGODB_DATABASE",
                            "value": "[parameters('databaseName')]"
                        },
                        {
                            "name": "K8S_CLUSTER_NAME",
                            "value": "[parameters('clusterName')]"
                        },
                        {
                            "name": "K8S_RESOURCE_GROUP",
                            "value": "[resourceGroup().name]"
                        },
                        {
                            "name": "K8S_SUBSCRIPTION_ID",
                            "value": "[subscription().subscriptionId]"
                        },
                        {
                            "name": "CLIENT_ID",
                            "value": "[parameters('servicePrincipalClientId')]"
                        },
                        {
                            "name": "CLIENT_SECRET",
                            "value": "[parameters('servicePrincipalClientSecret')]"
                        },
                        {
                            "name": "TENANT_ID",
                            "value": "[subscription().tenantId]"
                        }
                    ]
                }
            }
        },
        {
            "apiVersion": "2018-09-01-preview",
            "type": "Microsoft.CustomProviders/resourceProviders",
            "name": "radius",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[concat('Microsoft.Web/sites/', parameters('siteName'))]"
            ],
            "properties": {
                "resourceTypes": [
                    {
                        "name": "Applications",
                        "routingType": "Proxy,Cache",
                        "endpoint": "[concat('https://', parameters('siteName'), '.azurewebsites.net/{requestPath}')]"
                    },
                    {
                        "name": "Applications/Components",
                        "routingType": "Proxy,Cache",
                        "endpoint": "[concat('https://', parameters('siteName'), '.azurewebsites.net/{requestPath}')]"
                    },
                    {
                        "name": "Applications/Scopes",
                        "routingType": "Proxy,Cache",
                        "endpoint": "[concat('https://', parameters('siteName'), '.azurewebsites.net/{requestPath}')]"
                    },
                    {
                        "name": "Applications/Deployments",
                        "routingType": "Proxy,Cache",
                        "endpoint": "[concat('https://', parameters('siteName'), '.azurewebsites.net/{requestPath}')]"
                    }
                ]
            }
        }
    ]
}