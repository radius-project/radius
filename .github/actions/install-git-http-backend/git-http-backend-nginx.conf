server {
# Reference docs:
#   - Core directives: https://nginx.org/en/docs/http/ngx_http_core_module.html
#   - FastCGI params: https://nginx.org/en/docs/http/ngx_http_fastcgi_module.html
#   - HTTP auth basic: https://nginx.org/en/docs/http/ngx_http_auth_basic_module.html
#
# Expose the git-http-backend on port 3000 inside the cluster.
    listen 3000;
    server_name _;
    root ${GIT_SERVER_TEMP_DIR};

    # Require basic auth using credentials provisioned by the entrypoint script.
    auth_basic "Git Server";
    auth_basic_user_file /etc/nginx/.htpasswd;

    location / {
        client_max_body_size 0;
        include fastcgi_params;

        # Forward all requests to git-http-backend via fcgiwrap.
        fastcgi_pass unix:${SOCKET_DIR}/fcgiwrap.sock;
        fastcgi_param SCRIPT_FILENAME /config/git-http-backend-wrapper.sh;
        fastcgi_param PATH_INFO $uri;
        fastcgi_param SCRIPT_NAME $uri;
        fastcgi_param GIT_PROJECT_ROOT ${GIT_SERVER_TEMP_DIR};
        fastcgi_param GIT_HTTP_EXPORT_ALL 1;
        fastcgi_param GIT_HTTP_MAX_REQUEST_BUFFER 1048576000;
        fastcgi_param REMOTE_USER $remote_user;
        fastcgi_param HTTP_AUTHORIZATION $http_authorization;
    }
}
