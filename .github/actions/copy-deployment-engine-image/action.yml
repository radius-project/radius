# yaml-language-server: $schema=https://www.schemastore.org/github-action.json
---
name: Copy Deployment Engine Image
description: Copy a deployment engine image from Azure Container Registry to GitHub Container Registry.
inputs:
  tag:
    description: Tag to apply to the destination image and pull from the source image.
    required: true
  src_image:
    description: Name of the source image in Azure Container Registry (e.g. radiusdeploymentengine.azurecr.io/deployment-engine).
    required: true
  dest_image:
    description: Name of the GitHub Container Registry repository to push the deployment engine image to (e.g. ghcr.io/radius-project/deployment-engine).
    required: true

# Expected environment variables:
#   GHCR_PASSWORD: Password to authenticate against the destination registry.
#   DE_CONTAINER_AZURE_CLIENT_ID: Client ID for Azure login.
#   DE_CONTAINER_AZURE_TENANT_ID: Tenant ID for Azure login.
#   DE_CONTAINER_AZURE_SUBSCRIPTION_ID: Subscription ID for Azure login.

runs:
  using: composite
  steps:
    - name: Set up Buildx
      uses: docker/setup-buildx-action@v3

    - name: Parse inputs
      id: parse_inputs
      shell: bash
      env:
        TAG: ${{ inputs.tag }}
        SRC_IMAGE: ${{ inputs.src_image }}
        DEST_IMAGE: ${{ inputs.dest_image }}
      run: |
        # Example: SRC_IMAGE=radiusdeploymentengine.azurecr.io/deployment-engine
        #   -> src_registry=radiusdeploymentengine.azurecr.io, src_registry_name=radiusdeploymentengine
        # Example: DEST_IMAGE=ghcr.io/radius-project/deployment-engine
        #   -> dest_registry=ghcr.io, dest_registry_name=ghcr.io
        src_registry="${SRC_IMAGE%%/*}"
        dest_registry="${DEST_IMAGE%%/*}"
        {
          echo "src_registry=${src_registry}"
          echo "dest_registry=${dest_registry}"
          echo "src_registry_name=${src_registry%%.azurecr.io}"
          echo "dest_registry_name=${dest_registry}"
        } >> "$GITHUB_OUTPUT"

    - name: Log in to Azure
      uses: azure/login@v2
      with:
        client-id: ${{ env.DE_CONTAINER_AZURE_CLIENT_ID }}
        tenant-id: ${{ env.DE_CONTAINER_AZURE_TENANT_ID }}
        subscription-id: ${{ env.DE_CONTAINER_AZURE_SUBSCRIPTION_ID }}

    - name: Log in to ACR
      shell: bash
      env:
        SRC_REGISTRY_NAME: ${{ steps.parse_inputs.outputs.src_registry_name }}
      run: |
        # Example: SRC_REGISTRY_NAME=myregistry
        az acr login --name "${SRC_REGISTRY_NAME}"

    - name: Log in to GHCR
      uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
      with:
        registry: ${{ steps.parse_inputs.outputs.dest_registry }}
        username: rad-ci-bot
        password: ${{ env.GHCR_PASSWORD }}

    - name: Copy Deployment Engine image from ACR to GHCR
      shell: bash
      env:
        SRC_IMAGE: ${{ inputs.src_image }}
        DEST_IMAGE: ${{ inputs.dest_image }}
        TAG: ${{ inputs.tag }}
      run: |
        docker buildx imagetools create \
          --tag "${DEST_IMAGE}:${TAG}" \
          "${SRC_IMAGE}:${TAG}"
