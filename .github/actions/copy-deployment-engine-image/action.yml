# yaml-language-server: $schema=https://www.schemastore.org/github-action.json
---
name: Copy Deployment Engine image
description: Copy a deployment engine image from Azure Container Registry to GitHub Container Registry.
inputs:
  tag:
    description: Tag to apply to the destination image and pull from the source image.
    required: true
  acr-name:
    description: Name of the Azure Container Registry that hosts the deployment engine image.
    required: false
    default: radiusdeploymentengine
  source-repository:
    description: Repository name for the image inside the ACR.
    required: false
    default: deployment-engine
  destination-registry:
    description: Hostname for the destination registry (defaults to GHCR).
    required: false
    default: ghcr.io
  destination-repository:
    description: Repository path in the destination registry.
    required: false
    default: radius-project/deployment-engine
  ghcr-username:
    description: Username to authenticate against the destination registry.
    required: false
    default: rad-ci-bot

# Expected environment variables:
#   GHCR_PASSWORD: Password to authenticate against the destination registry.
#   DE_CONTAINER_AZURE_CLIENT_ID: Client ID for Azure login.
#   DE_CONTAINER_AZURE_TENANT_ID: Tenant ID for Azure login.
#   DE_CONTAINER_AZURE_SUBSCRIPTION_ID: Subscription ID for Azure login.

runs:
  using: composite
  steps:
    - name: Set up Buildx
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

    - name: Log in to Azure
      uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2.3.0
      with:
        client-id: ${{ env.DE_CONTAINER_AZURE_CLIENT_ID }}
        tenant-id: ${{ env.DE_CONTAINER_AZURE_TENANT_ID }}
        subscription-id: ${{ env.DE_CONTAINER_AZURE_SUBSCRIPTION_ID }}

    - name: Log in to Azure Container Registry
      shell: bash
      run: |
        az acr login --name "${{ inputs.acr-name }}"

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
      with:
        registry: ${{ inputs.destination-registry }}
        username: ${{ inputs.ghcr-username }}
        password: ${{ env.GHCR_PASSWORD }}

    - name: Copy Deployment Engine image from ACR to GHCR
      shell: bash
      env:
        TAG: ${{ inputs.tag }}
        ACR_NAME: ${{ inputs.acr-name }}
        SRC_REPO: ${{ inputs.source-repository }}
        DEST_REGISTRY: ${{ inputs.destination-registry }}
        DEST_REPO: ${{ inputs.destination-repository }}
      run: |
        docker buildx imagetools create \
          --tag "${DEST_REGISTRY}/${DEST_REPO}:${TAG}" \
          "${ACR_NAME}.azurecr.io/${SRC_REPO}:${TAG}"
