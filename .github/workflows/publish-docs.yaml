name: Generate reference docs

on:
  workflow_dispatch:
  push:
    branches:
      - main
      # - release/*
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
      # - release/*

jobs:
  cli-docs:
    name: Generate CLI reference docs
    runs-on: ubuntu-latest
    env:
      GOVER: '^1.17'
    steps:
      - name: Checkout docs repository
        uses: actions/checkout@v3
        with:
          repository: project-radius/docs
          token: ${{ secrets.GH_RAD_CI_BOT_PAT }}
      - name: Setup Go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ env.GOVER }}
      - name: Restore Go Modules Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('radius/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Generate CLI docs
        run: |
            find docs/content/reference/cli -type f ! -name '_index.md' -delete
            go run tools/cli-docsgen/main.go docs/content/reference/cli
      - name: Upload CLI docs
        uses: actions/upload-artifact@v3
        with:
          name: cli-docs
          path: docs/content/reference/cli
      - name: Create pull request
        uses: peter-evans/create-pull-request@v4
        # Temporarily commenting out the if condition while testing
        # if: github.event_name != 'pull_request'
        with:
          token: ${{ secrets.GH_RAD_CI_BOT_PAT }}
          add-paths: |
            docs/content/reference/cli/*.md
          committer: rad-ci-bot <rad-ci-bot@users.noreply.github.com>
          author: rad-ci-bot <rad-ci-bot@users.noreply.github.com>
          branch: reference-cli/patch-${{ github.sha }}
          delete-branch: true
          title: |
            Update rad CLI documentation
          body: |
            ## Autogenerated PR
            
            This PR updates the rad CLI reference documentation.

            GitHub SHA: ${{ github.sha }}
          commit-message: |
            Autogenerate rad CLI reference docs
