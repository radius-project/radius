# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
---
name: Generate reference docs

on:
  workflow_dispatch:
    inputs:
      open_pull_request:
        description: |
          Open a pull request against the docs repository. Defaults to false for a "dry run" of the workflow that generates the docs and uploads them as artifacts.
        required: false
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
  push:
    branches:
      - main
      - release/*
  pull_request:
    branches:
      - main

permissions: {}

jobs:
  changes:
    name: Changes
    uses: ./.github/workflows/__changes.yml
    permissions:
      contents: read
      pull-requests: read

  reference-docs:
    name: Generate and PR reference documentation
    if: github.repository == 'radius-project/radius' && needs.changes.outputs.only_changed != 'true'
    needs: [changes]
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    env:
      GOPRIVATE: github.com/radius-project
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout radius repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: radius-project/radius
          path: radius
          submodules: recursive
          persist-credentials: false

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version-file: radius/.python-version

      - name: Parse release version and set environment variables
        run: python radius/.github/scripts/get_release_version.py

      - name: Generate docs release branch name
        run: |
          if [[ ${{ env.REL_CHANNEL }} != "edge" ]]; then
            echo DOCS_BRANCH="v${{ env.REL_CHANNEL }}" >> $GITHUB_ENV
          else
            echo DOCS_BRANCH="edge" >> $GITHUB_ENV
          fi

      - name: Checkout docs repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: radius-project/docs
          path: docs
          ref: ${{ env.DOCS_BRANCH }}
          persist-credentials: false

      # Setup dependencies
      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: radius/go.mod
          cache-dependency-path: radius/go.sum
          cache: true

      - name: Setup NodeJS
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: radius/.node-version

      - name: Install TypeSpec compiler
        run: |
          pushd radius/typespec
          npm ci
          popd

      - name: Install autorest
        run: npm install -g autorest@3.7.2

      - name: Install oav
        run: npm install -g oav@4.0.2

      - name: Install mockgen
        run: |
          cd radius
          go install go.uber.org/mock/mockgen@v0.4.0

      - name: Install controller-gen
        run: |
          cd radius
          go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.17.0

      # Generate Bicep docs
      - name: Generate Bicep docs
        run: |
          cd radius
          make generate

      # Generate resource reference docs
      - name: Generate resource reference docs
        run: python docs/.github/scripts/generate_resource_references.py ./radius/hack/bicep-types-radius/generated/ ./docs/docs/content/reference/resources

      - name: Upload resource reference docs
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: resource-docs
          path: docs/docs/content/reference/resources

      # Generate and upload CLI docs
      - name: Generate CLI docs
        run: |
          find docs/docs/content/reference/cli -type f ! -name '_index.md' -delete
          cd radius
          go run cmd/docgen/main.go ../docs/docs/content/reference/cli

      - name: Upload CLI docs
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: cli-docs
          path: docs/docs/content/reference/cli

      # Open PR against docs repository
      - name: Show git diff
        run: |
          cd docs
          git status --porcelain -unormal -- *.md

      # Prepare PR context information based on trigger type
      # This step captures details about what triggered the workflow and formats them
      # into a meaningful PR title and body for the auto-generated docs PR.
      #
      # Scenarios handled:
      # 1. Push events from merged PRs (detected by "(#123)" pattern in commit message)
      #    - Extracts PR number and title from the commit message
      #    - Creates a link back to the original PR
      # 2. Push events from direct commits (no PR pattern in message)
      #    - Includes branch name, commit SHA, author, and commit message
      # 3. Manual workflow_dispatch events
      #    - Includes who triggered it and the current branch/commit
      - name: Prepare PR context
        id: pr-context
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.open_pull_request == 'true')
        run: |
          # Change to radius directory to extract commit information
          # Note: ${{ github.sha }} refers to the triggering commit in the radius repository
          cd radius
          
          # Extract commit information
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s" ${{ github.sha }})
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an" ${{ github.sha }})
          
          # Determine the source of this workflow run
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Triggered by a push to main or release branch
            # Check if this is a merge commit from a PR
            # GitHub's squash merge format: "Title (#123)" - PR number at end of message
            # This pattern specifically targets squash merges, which is the default for this repo
            if [[ "$COMMIT_MESSAGE" =~ \(#([0-9]+)\)$ ]]; then
              # Extract PR number from commit message
              PR_NUMBER="${BASH_REMATCH[1]}"
              
              # For merged PRs, try to get the PR title (everything before " (#123)")
              PR_TITLE="${COMMIT_MESSAGE% (#$PR_NUMBER)}"
              
              echo "pr-title=Update auto-generated documentation (PR #$PR_NUMBER)" >> $GITHUB_OUTPUT
              echo "pr-body<<EOF" >> $GITHUB_OUTPUT
              echo "## Autogenerated PR" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "This PR updates the auto-generated reference documentation." >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "### Triggered by" >> $GITHUB_OUTPUT
              echo "**Pull Request:** [#$PR_NUMBER - $PR_TITLE](https://github.com/${{ github.repository }}/pull/$PR_NUMBER)" >> $GITHUB_OUTPUT
              echo "**Branch:** \`${GITHUB_REF##*/}\`" >> $GITHUB_OUTPUT
              echo "**Commit:** [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_OUTPUT
              echo "**Author:** $COMMIT_AUTHOR" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              # Regular push commit (not from a PR merge)
              echo "pr-title=Update auto-generated documentation (${GITHUB_REF##*/})" >> $GITHUB_OUTPUT
              echo "pr-body<<EOF" >> $GITHUB_OUTPUT
              echo "## Autogenerated PR" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "This PR updates the auto-generated reference documentation." >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "### Triggered by" >> $GITHUB_OUTPUT
              echo "**Branch:** \`${GITHUB_REF##*/}\`" >> $GITHUB_OUTPUT
              echo "**Commit:** [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_OUTPUT
              echo "**Author:** $COMMIT_AUTHOR" >> $GITHUB_OUTPUT
              echo "**Message:** $COMMIT_MESSAGE" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          else
            # Triggered by workflow_dispatch
            echo "pr-title=Update auto-generated documentation (manual trigger)" >> $GITHUB_OUTPUT
            echo "pr-body<<EOF" >> $GITHUB_OUTPUT
            echo "## Autogenerated PR" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "This PR updates the auto-generated reference documentation." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### Triggered by" >> $GITHUB_OUTPUT
            echo "**Trigger:** Manual workflow dispatch" >> $GITHUB_OUTPUT
            echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_OUTPUT
            echo "**Branch:** \`${GITHUB_REF##*/}\`" >> $GITHUB_OUTPUT
            echo "**Commit:** [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_OUTPUT
            echo "**Commit Message:** $COMMIT_MESSAGE" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create pull request
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.open_pull_request == 'true')
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          token: ${{ secrets.GH_RAD_CI_BOT_PAT }}
          path: docs
          add-paths: |
            *.md
          committer: rad-ci-bot <rad-ci-bot@users.noreply.github.com>
          author: rad-ci-bot <rad-ci-bot@users.noreply.github.com>
          signoff: true
          branch: reference-cli/patch-${{ github.sha }}
          delete-branch: true
          title: ${{ steps.pr-context.outputs.pr-title }}
          body: ${{ steps.pr-context.outputs.pr-body }}
          commit-message: |
            Autogenerate reference docs
