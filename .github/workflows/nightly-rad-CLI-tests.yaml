# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
---
name: Nightly rad CLI tests

on:
  schedule:
    # Run every day at 11:47 PM UTC
    - cron: 47 23 * * *
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - .github/workflows/nightly-rad-CLI-tests.yaml

permissions: {}

jobs:
  get-version:
    if: github.repository == 'radius-project/radius'
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      rad_version: ${{ steps.get-version.outputs.rad_version }}
    steps:
      - name: Get latest release version
        id: get-version
        run: |
          echo "Fetching latest release version from GitHub API..."
          radReleaseUrl="https://api.github.com/repos/radius-project/radius/releases"

          api_response=$(curl -s "$radReleaseUrl")
          curl_exit_code=$?

          if [ $curl_exit_code -ne 0 ]; then
              echo "GitHub API call failed with exit code: $curl_exit_code"
              exit 1
          fi

          echo "GitHub API call successful"

          # Extract version from API response using jq
          # Select the first release that is not an RC (release candidate)
          RAD_VERSION=$(echo "$api_response" | jq -r '[.[] | select(.tag_name | test("rc") | not)] | .[0].tag_name // empty') || true

          if [ -z "$RAD_VERSION" ]; then
              echo "Failed to extract RAD_VERSION from API response"
              echo "API Response (first 50 lines):"
              echo "$api_response" | head -n 50
              exit 1
          fi

          echo "Successfully retrieved RAD_VERSION: $RAD_VERSION"
          echo "rad_version=$RAD_VERSION" >> "$GITHUB_OUTPUT"

  download:
    needs: get-version
    if: github.repository == 'radius-project/radius'
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            file: rad
          - os: linux
            arch: arm64
            file: rad
          - os: linux
            arch: arm
            file: rad
          - os: darwin
            arch: amd64
            file: rad
          - os: darwin
            arch: arm64
            file: rad
          - os: windows
            arch: amd64
            file: rad
            ext: .exe
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Test CLI download
        run: make test-cli-download OS=${{ matrix.os }} ARCH=${{ matrix.arch }} FILE=${{ matrix.file }} EXT=${{ matrix.ext }} RAD_VERSION=${{ needs.get-version.outputs.rad_version }}

      - name: Create GitHub issue on failure
        if: ${{ failure() }}
        run: |
          gh issue create --title "CLI nightly test failed - ${{ matrix.os }}-${{ matrix.arch }}" --body "Test failed on ${{ github.repository }} for ${{ matrix.os }}-${{ matrix.arch }}. See [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details." --label "test-failure" --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.GH_RAD_CI_BOT_PAT }}
