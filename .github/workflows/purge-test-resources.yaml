# ------------------------------------------------------------
# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.
# ------------------------------------------------------------

name: Purge test resources
on:
  # for testing
  pull_request:
    branches:
      - main
      - features/*
      - release/*
  schedule:
    # Run at 23:05 on Sunday.
    - cron: "5 23 * * 0"
env:
  # The test subscription id for testing.
  AZURE_SUBSCRIPTION_ID: '85716382-7362-45c3-ae03-2126e459a123'
  DELETED_RESOURCE_GROUP_LIST_FILE: 'az_rg_list.txt'
jobs:
  purge_azure_resources:
    name: Purge test azure resource groups
    runs-on: [self-hosted,1ES.Pool=1ES-Radius ]
    steps:
      - name: Setup Azure CLI
        run: curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: '{"clientId":"${{ secrets.AZURE_SP_TESTS_APPID }}","clientSecret":"${{ secrets.AZURE_SP_TESTS_PASSWORD }}","subscriptionId":"${{ env.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_SP_TESTS_TENANTID }}"}'
      - name: Find all deleting resource groups
        run: |
          az account set -s ${{ env.AZURE_SUBSCRIPTION_ID }}
          az group list --query "[?starts_with(name, 'radius-')].{name:name}" --output table|grep radius- > ${{ env.DELETED_RESOURCE_GROUP_LIST_FILE}}
          az group list --query "[?starts_with(name, 'radtest-')].{name:name}" --output table|grep radtest- >> ${{ env.DELETED_RESOURCE_GROUP_LIST_FILE}}
          cat ${{ env.DELETED_RESOURCE_GROUP_LIST_FILE}}
          echo "## Deleting Azure resource groups:" >> $GITHUB_STEP_SUMMARY
      - name: Delete Azure resource groups
        run: |
          cat ${{ env.DELETED_RESOURCE_GROUP_LIST_FILE}} | while read line
          do
              echo " * $line" >> $GITHUB_STEP_SUMMARY
              # az group delete --resource-group $line --yes
          done
