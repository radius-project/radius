name: "Approve Functional Tests"
on:
  pull_request:
    branches:
      - main
      - features/*
      - release/*

env:
  # GitHub Actor for pushing images to GHCR
  GHCR_ACTOR: rad-ci-bot
  # Container registry url for GitHub container registry.
  CONTAINER_REGISTRY: "ghcr.io/radius-project"

jobs:
  approve-functional-tests-run:
    name: "Approve Functional Tests"
    runs-on: ubuntu-latest
    environment: functional-tests
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout Radius repository
        uses: actions/checkout@v5

      - name: Save PR number
        uses: ./.github/actions/save-pr-as-artifact

      - name: Set REL_VERSION for PR
        run: |
          echo "REL_VERSION=pr-${{ github.event.number }}" >> $GITHUB_ENV

      - name: Download container images
        uses: actions/download-artifact@v4
        with:
          name: container-images-${{ env.REL_VERSION }}
          path: ./dist/images/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ env.GHCR_ACTOR }}
          password: ${{ secrets.GH_RAD_CI_BOT_PAT }}

      - name: Load and push container images to dev registry
        run: |
          # Load images from artifacts
          make docker-load-images
          # Push to dev registry for functional tests
          make docker-multi-arch-push
        env:
          DOCKER_REGISTRY: ${{ env.CONTAINER_REGISTRY }}/dev
          DOCKER_TAG_VERSION: ${{ env.REL_VERSION }}
