# ------------------------------------------------------------
# Copyright 2023 The Radius Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# yaml-language-server: $schema=https://www.schemastore.org/github-workflow.json
---
name: Functional Tests (with Non-Cloud Resources)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: Branch to run the workflow on
        required: true
        default: main
  schedule:
    # Run three times a day at 6 AM PDT (1 PM UTC), 12 PM PDT (7 PM UTC), and 6 PM PDT (1 AM UTC next day)
    - cron: 0 1,13,19 * * *
  # Dispatch on external events
  repository_dispatch:
    types: [deployment-engine.run-functional-tests]
    # Expected client_payload:
    #   src_image: Source image in ACR (e.g. radiusdeploymentengine.azurecr.io/deployment-engine)
    #   dest_image: Destination image in GHCR (e.g. ghcr.io/radius-project/deployment-engine)
    #   tag: Tag for the image (e.g. latest, 0.1, 0.1.0-rc1, pr-123)
  pull_request:
    branches:
      - main
      - features/*
      - release/*

permissions: {}

env:
  # Helm version
  HELM_VER: v3.19.4
  # KinD cluster version
  KIND_VER: v0.29.0
  # Kubectl version
  KUBECTL_VER: v1.30.0
  # Dapr CLI version
  DAPR_CLI_VER: 1.15.1
  # Dapr runtime version
  DAPR_RUNTIME_VER: 1.15.4
  # Dapr dashboard version
  DAPR_DASHBOARD_VER: 0.15.0
  # The radius functional test timeout
  FUNCTIONALTEST_TIMEOUT: 15m
  RADIUS_CONTAINER_LOG_BASE: dist/container_logs
  RADIUS_CHART_LOCATION: deploy/Chart/
  # The current GitHub action link
  ACTION_LINK: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
  # Server where terraform test modules are deployed
  TF_RECIPE_MODULE_SERVER_URL: http://tf-module-server.radius-test-tf-module-server.svc.cluster.local
  # Private Git repository where terraform module for testing is stored.
  TF_RECIPE_PRIVATE_GIT_SOURCE: git::https://github.com/radius-project/terraform-private-modules//kubernetes-redis
  # Local Docker registry name
  LOCAL_REGISTRY_NAME: radius-registry
  # Local Docker registry server
  LOCAL_REGISTRY_SERVER: localhost
  # Local Docker registry port
  LOCAL_REGISTRY_PORT: "5000"
  # bicep-types ACR url for uploading Radius Bicep types
  BICEP_TYPES_REGISTRY: biceptypes.azurecr.io
  # Git HTTP server URL
  GIT_HTTP_SERVER_URL: http://localhost:30080
  # Git username used for pushing commits during tests
  GIT_HTTP_USERNAME: testuser
  # Git email used for commit authorship during tests
  GIT_HTTP_EMAIL: testuser@radapp.io
  # Git password used for pushing commits during tests
  GIT_HTTP_PASSWORD: not-a-secret-password
  # Kubernetes client QPS and Burst settings for high-concurrency CI environments
  RADIUS_QPS_AND_BURST: "800"

jobs:
  changes:
    name: Changes
    uses: ./.github/workflows/__changes.yml
    permissions:
      contents: read
      pull-requests: read

  build:
    name: Build Radius for test
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    needs: [changes]
    if: needs.changes.outputs.only_changed != 'true'
    permissions:
      id-token: write # Required for requesting the JWT
      contents: read # Required for listing the commits
      packages: write # Required for uploading the package
      checks: write # Required for creating a check run
    env:
      DE_IMAGE: ghcr.io/radius-project/deployment-engine
      DE_TAG: latest
    outputs:
      REL_VERSION: ${{ steps.gen-id.outputs.REL_VERSION }}
      DE_IMAGE: ${{ steps.gen-id.outputs.DE_IMAGE }}
      DE_TAG: ${{ steps.gen-id.outputs.DE_TAG }}
      RAD_CLI_ARTIFACT_NAME: ${{ steps.gen-id.outputs.RAD_CLI_ARTIFACT_NAME }}
    steps:
      - name: Set DE image and tag (repository_dispatch from deployment-engine.run-functional-tests)
        if: github.event_name == 'repository_dispatch'
        shell: bash
        env:
          DEST_IMAGE: ${{ github.event.client_payload.dest_image }}
          TAG: ${{ github.event.client_payload.tag }}
        run: |
          {
            echo "DE_IMAGE=${DEST_IMAGE}"
            echo "DE_TAG=${TAG}"
          } >> "$GITHUB_ENV"

      - name: Generate ID for release
        id: gen-id
        run: |
          BASE_STR="RADIUS|${GITHUB_SHA}|${GITHUB_SERVER_URL}|${GITHUB_REPOSITORY}|${GITHUB_RUN_ID}|${GITHUB_RUN_ATTEMPT}"
          if [ "$GITHUB_EVENT_NAME" == "schedule" ]; then
            BASE_STR="${GITHUB_RUN_NUMBER}|${BASE_STR}"
          fi
            UNIQUE_ID=func$(echo $BASE_STR | sha1sum | head -c 10)
            echo "REL_VERSION=pr-${UNIQUE_ID}" >> $GITHUB_ENV
            echo "REL_VERSION=pr-${UNIQUE_ID}" >> $GITHUB_OUTPUT
            echo "DE_IMAGE=${{ env.DE_IMAGE }}" >> $GITHUB_OUTPUT
            echo "DE_TAG=${{ env.DE_TAG }}" >> $GITHUB_OUTPUT
            echo "RAD_CLI_ARTIFACT_NAME=rad_cli_linux_amd64" >> $GITHUB_OUTPUT

          # Set output variables to be used in the other jobs
          {
            echo "REL_VERSION=pr-${UNIQUE_ID}"
            echo "DE_IMAGE=${{ env.DE_IMAGE }}"
            echo "DE_TAG=${{ env.DE_TAG }}"
          } >> "${GITHUB_OUTPUT}"

  tests:
    name: Run ${{ matrix.name }} functional tests
    needs: [changes, build]
    if: needs.changes.outputs.only_changed != 'true'
    permissions:
      contents: read # Required for listing the commits
      checks: write # Required for creating a check run
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-24.04]
        name:
          [
            cli-noncloud,
            corerp-noncloud,
            daprrp-noncloud,
            kubernetes-noncloud,
            msgrp-noncloud,
            samples-noncloud,
            ucp-noncloud,
            datastoresrp-noncloud,
            dynamicrp-noncloud,
            upgrade-noncloud,
          ]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    env:
      REL_VERSION: ${{ needs.build.outputs.REL_VERSION }}
      BICEP_RECIPE_TAG_VERSION: ${{ needs.build.outputs.REL_VERSION }}
      DE_IMAGE: ${{ needs.build.outputs.DE_IMAGE }}
      DE_TAG: ${{ needs.build.outputs.DE_TAG }}
    steps:
      - name: Set up checkout target (scheduled)
        if: github.event_name == 'schedule' || github.event_name == 'repository_dispatch'
        run: |
          {
            echo "CHECKOUT_REPO=${{ github.repository }}"
            echo "CHECKOUT_REF=refs/heads/main"
          } >> "${GITHUB_ENV}"

      - name: Set up checkout target (pull_request)
        if: github.event_name == 'pull_request'
        run: |
          {
            echo "CHECKOUT_REPO=${{ github.repository }}"
            echo "CHECKOUT_REF=${{ github.ref }}"
            echo "PR_NUMBER=${{ github.event.pull_request.number }}"
          } >> "${GITHUB_ENV}"

      - name: Set up checkout target (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        run: |
          {
            echo "CHECKOUT_REPO=${{ github.repository }}"
            echo "CHECKOUT_REF=refs/heads/${{ github.event.inputs.branch }}"
          } >> "${GITHUB_ENV}"

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: recursive
          persist-credentials: false

      - name: Checkout samples repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        if: matrix.name == 'samples-noncloud'
        with:
          repository: radius-project/samples
          ref: refs/heads/edge
          path: samples
          persist-credentials: false

      - name: Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: go.mod
          cache-dependency-path: go.sum
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
          node-version-file: .node-version

      - name: Generate Bicep extensibility types from OpenAPI specs
        run: |
          make generate-bicep-types VERSION=${{ env.REL_VERSION == 'edge' && 'latest' || env.REL_VERSION }}

      - name: Upload Radius Bicep types artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ matrix.name }}_radius_bicep_types
          path: ./hack/bicep-types-radius/generated
          if-no-files-found: error

      - name: Create a secure local registry
        id: create-local-registry
        uses: ./.github/actions/create-local-registry
        with:
          secure: "true"
          registry-name: ${{ env.LOCAL_REGISTRY_NAME }}
          registry-server: ${{ env.LOCAL_REGISTRY_SERVER }}
          registry-port: ${{ env.LOCAL_REGISTRY_PORT }}

      - name: Download built images
        uses: actions/download-artifact@v5
        with:
          name: radius_images
          path: dist/images

      - name: Load images into local Docker and push to local registry
        run: |
          set -e
          for f in dist/images/*.tar; do
            [ -e "$f" ] || continue
            name=$(basename "$f" .tar)
            tag="${{ env.LOCAL_REGISTRY_NAME }}:${{ env.LOCAL_REGISTRY_PORT }}/$name:${{ env.REL_VERSION }}"
            echo "Loading $f into Docker and pushing $tag"
            docker load -i "$f"
            docker tag "$tag" "$tag" || true
            docker push "$tag"
          done

      - name: Load images into KinD nodes
        run: |
          for f in dist/images/*.tar; do
            [ -e "$f" ] || continue
            kind load image-archive "$f" --name kind
          done

      - name: Verify images present in node
        run: |
          docker exec kind-control-plane crictl images | sed -n '1,200p' || true
          for img in controller ucpd applications-rp dynamic-rp bicep; do
            if docker exec kind-control-plane crictl images | grep -q "radius-registry:5000/$img:${{ env.REL_VERSION }}"; then
              echo "Found radius-registry:5000/$img:${{ env.REL_VERSION }}"
            else
              echo "MISSING radius-registry:5000/$img:${{ env.REL_VERSION }}"; fi; done

      - name: Download rad CLI
        uses: actions/download-artifact@v5
        with:
          name: ${{ env.RAD_CLI_ARTIFACT_NAME }}
          path: bin

      - name: Verify rad CLI
        run: |
          chmod +x ./bin/rad
          export PATH=$GITHUB_WORKSPACE/bin:$PATH
          which rad || { echo "cannot find rad"; exit 1; }
          rad bicep download
          rad version

      - uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VER }}

      - name: Setup and verify bicep CLI
        run: |
          curl -Lo bicep https://github.com/Azure/bicep/releases/latest/download/bicep-linux-x64
          chmod +x ./bicep
          sudo mv ./bicep /usr/local/bin/bicep
          bicep --version

      - name: Publish bicep types
        run: |
          bicep publish-extension ./hack/bicep-types-radius/generated/index.json --target br:${{ env.LOCAL_REGISTRY_SERVER }}:${{ env.LOCAL_REGISTRY_PORT }}/radius:${{ env.REL_VERSION == 'edge' && 'latest' || env.REL_VERSION }} --force
        env:
          SSL_CERT_FILE: ${{ steps.create-local-registry.outputs.temp-cert-dir }}/certs/${{ env.LOCAL_REGISTRY_SERVER }}/client.crt

      - name: Install Radius
        run: |
          export PATH=$GITHUB_WORKSPACE/bin:$PATH
          which rad || { echo "cannot find rad"; exit 1; }
          if helm status radius -n radius-system >/dev/null 2>&1; then
            echo "The release 'radius' exists. Deleting the release..."
            helm delete radius -n radius-system || exit 1
          else
            echo "Radius release not found. Proceeding with installation."
          fi
          RAD_COMMAND="rad install kubernetes \
            --chart ${{ env.RADIUS_CHART_LOCATION }} \
            --set global.imageRegistry=${{ env.LOCAL_REGISTRY_NAME }}:${{ env.LOCAL_REGISTRY_PORT }} \
            --set global.imageTag=${{ env.REL_VERSION }} \
            --set global.imagePullPolicy=IfNotPresent \
            --set dashboard.enabled=false \
            --set de.image=${{ env.DE_IMAGE }},de.tag=${{ env.DE_TAG }}"
          if [ "${{ env.USE_CERT_FILE }}" = "true" ]; then
            RAD_COMMAND="$RAD_COMMAND --set-file global.rootCA.cert=$TEMP_CERT_DIR/certs/${{ env.LOCAL_REGISTRY_SERVER }}/client.crt"
          fi
          echo "*** Installing Radius to Kubernetes ***"
          eval $RAD_COMMAND
          echo "*** Verify manifests are registered ***"
          rm -f registermanifest_logs.txt
          POD_NAME=$(kubectl get pods -n radius-system -o jsonpath='{range .items[*]}{.metadata.name}{" "}{.spec.containers[*].name}{"\n"}{end}' | grep "ucp" | head -n1 | cut -d" " -f1)
          echo "Found ucp pod: $POD_NAME"
          if [ -z "$POD_NAME" ]; then
            echo "No pod with container 'ucp' found in namespace radius-system."; exit 1; fi
          for i in {1..6}; do
            kubectl logs "$POD_NAME" -n radius-system | tee registermanifest_logs.txt > /dev/null

            # Exit on error
            if grep -qi "Service initializer terminated with error" registermanifest_logs.txt; then
              echo "Error found in ucp logs."; grep -i "Service initializer terminated with error" registermanifest_logs.txt; exit 1; fi
            if grep -q "Successfully registered manifests" registermanifest_logs.txt; then
              echo "Successfully registered manifests - message found."; break; fi
            echo "Logs not ready, waiting 30 seconds..."; sleep 30
          done
          if ! grep -q "Successfully registered manifests" registermanifest_logs.txt; then
            echo "Manifests not registered after 3 minutes."; exit 1; fi
          echo "*** Create workspace, group and environment for test ***"
          rad workspace create kubernetes
        env:
          USE_CERT_FILE: "true"
          TEMP_CERT_DIR: ${{ steps.create-local-registry.outputs.temp-cert-dir }}

      - name: Install Flux (kubernetes-noncloud)
        if: matrix.name == 'kubernetes-noncloud'
        uses: ./.github/actions/install-flux

      - name: Debug install failure (noncloud)
        if: failure()
        run: |
          echo "==== radius-system pods"; kubectl get pods -n radius-system -o wide || true
          echo "==== radius-system events (latest)"; kubectl get events -n radius-system --sort-by=.lastTimestamp | tail -n 200 || true
          echo "==== helm status"; helm status radius -n radius-system || true
          echo "==== describe deployments"; kubectl describe deploy -n radius-system || true
          echo "==== describe pods"; for p in $(kubectl get pods -n radius-system -o name); do echo "---- $p ----"; kubectl describe "$p" -n radius-system || true; done

      - name: Install Flux CLI and Source Controller
        if: matrix.name == 'kubernetes-noncloud'
        uses: ./.github/actions/install-flux

      - name: Install Git HTTP backend
        if: matrix.name == 'kubernetes-noncloud'
        uses: ./.github/actions/install-git-http-backend
        with:
          git-username: ${{ env.GIT_HTTP_USERNAME }}
          git-password: ${{ env.GIT_HTTP_PASSWORD }}

      - name: Port-forward to Git server
        if: matrix.name == 'kubernetes-noncloud'
        run: |
          # Start port forwarding in the background
          kubectl port-forward -n git-http-backend svc/git-http 30080:3000 &

          # Wait for port forwarding to be established
          sleep 5

          # Test the connection to ensure port forwarding is working
          curl -s http://localhost:30080 > /dev/null || (echo "Port forwarding failed" && exit 1)

          echo "Port forwarding established successfully"

      - name: Publish UDT types
        run: |
          export PATH=$GITHUB_WORKSPACE/bin:$PATH
          which rad || { echo "cannot find rad"; exit 1; }
          rad bicep publish-extension -f ./test/functional-portable/dynamicrp/noncloud/resources/testdata/testresourcetypes.yaml --target br:${{ env.LOCAL_REGISTRY_SERVER }}:${{ env.LOCAL_REGISTRY_PORT }}/testresources:${{ env.REL_VERSION == 'edge' && 'latest' || env.REL_VERSION }} --force

      - name: Generate test bicepconfig.json
        run: |
          if [[ "${{ env.REL_VERSION }}" == "edge" ]]; then RADIUS_VERSION="latest"; else RADIUS_VERSION="${{ env.REL_VERSION }}"; fi
          cat <<EOF > ./test/bicepconfig.json
          {
            "experimentalFeaturesEnabled": { "extensibility": true },
            "extensions": {
              "radius": "br:${{ env.LOCAL_REGISTRY_SERVER }}:${{ env.LOCAL_REGISTRY_PORT }}/radius:$RADIUS_VERSION",
              "aws": "br:${{ env.BICEP_TYPES_REGISTRY }}/aws:latest",
              "testresources": "br:${{ env.LOCAL_REGISTRY_SERVER }}:${{ env.LOCAL_REGISTRY_PORT }}/testresources:$RADIUS_VERSION"
            }
          }
          EOF
          cp -f ./test/bicepconfig.json ./test/functional-portable/dynamicrp/noncloud/resources/bicepconfig.json

      - name: Publish Bicep Test Recipes
        run: |
          export PATH=$GITHUB_WORKSPACE/bin:$PATH
          which rad || { echo "cannot find rad"; exit 1; }
          make publish-test-bicep-recipes
        env:
          BICEP_RECIPE_REGISTRY: ${{ env.LOCAL_REGISTRY_SERVER }}:${{ env.LOCAL_REGISTRY_PORT }}
          BICEP_RECIPE_TAG_VERSION: ${{ env.REL_VERSION }}
          TEMP_CERT_DIR: ${{ steps.create-local-registry.outputs.temp-cert-dir }}
          SSL_CERT_FILE: ${{ steps.create-local-registry.outputs.temp-cert-dir }}/certs/${{ env.LOCAL_REGISTRY_SERVER }}/client.crt

      - name: Run functional tests
        run: |
          export PATH=$GITHUB_WORKSPACE/bin:$PATH
          # Make directory to capture functional test results
          mkdir -p ./dist/functional_test
          cd $GITHUB_WORKSPACE

          which rad || { echo "cannot find rad"; exit 1; }
          make test-functional-${{ matrix.name }}
        env:
          DOCKER_REGISTRY: ${{ env.LOCAL_REGISTRY_NAME }}:${{ env.LOCAL_REGISTRY_PORT }}
          TEST_TIMEOUT: ${{ env.FUNCTIONALTEST_TIMEOUT }}
          RADIUS_CONTAINER_LOG_PATH: ${{ github.workspace }}/${{ env.RADIUS_CONTAINER_LOG_BASE }}
          RADIUS_SAMPLES_REPO_ROOT: ${{ github.workspace }}/samples
          BICEP_RECIPE_REGISTRY: ${{ env.LOCAL_REGISTRY_NAME }}:${{ env.LOCAL_REGISTRY_PORT }}
          BICEP_RECIPE_TAG_VERSION: ${{ env.BICEP_RECIPE_TAG_VERSION }}
          GH_TOKEN: ${{ github.token }}
          GOTESTSUM_OPTS: --junitfile ./dist/functional_test/results.xml
          RADIUS_TEST_FAST_CLEANUP: true
          GIT_HTTP_PASSWORD: ${{ env.GIT_HTTP_PASSWORD }}

      - name: Publish bicep types
        run: |
          bicep publish-extension ./hack/bicep-types-radius/generated/index.json --target br:${{ env.LOCAL_REGISTRY_SERVER }}:${{ env.LOCAL_REGISTRY_PORT }}/radius:${{ env.REL_VERSION == 'edge' && 'latest' || env.REL_VERSION }} --force
() && github.repository == 'radius-project/radius'
        with:
          test_group_name: Functional Tests - ${{ matrix.name }}
          artifact_name: functional_test_results_${{ matrix.name }}
          result_directory: dist/functional_test/

      - name: Collect detailed Radius logs and events
        id: radius-logs-events
        if: always()
        run: |
          mkdir -p func-nc/radius-logs-events/${{ matrix.name }}
          namespace="radius-system"
          pod_names=($(kubectl get pods -n $namespace -o jsonpath='{.items[*].metadata.name}'))
          for pod_name in "${pod_names[@]}"; do
            kubectl logs $pod_name -n $namespace > func-nc/radius-logs-events/${{ matrix.name }}/${pod_name}.txt 2>&1 || echo "Failed to get logs for pod: $pod_name" > func-nc/radius-logs-events/${{ matrix.name }}/${pod_name}.txt
          done
          kubectl get events -n $namespace > func-nc/radius-logs-events/${{ matrix.name }}/events.txt

      - name: Upload Pod logs for failed tests
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always() && steps.radius-logs-events.outcome == 'success'
        with:
          name: ${{ matrix.name }}-radius-pod-logs
          path: func-nc/radius-logs-events/${{ matrix.name }}
          retention-days: 30
          if-no-files-found: error

      - name: Collect Pod details
        if: always()
        run: |
          POD_STATE_LOG_FILENAME='${{ env.RADIUS_CONTAINER_LOG_BASE }}/${{ matrix.name }}-tests-pod-states.log'
          mkdir -p $(dirname $POD_STATE_LOG_FILENAME)
          {
            echo "kubectl get pods -A"
            kubectl get pods -A
            echo "kubectl describe pods -A"
            kubectl describe pods -A
          }  >> "${POD_STATE_LOG_FILENAME}"

      - name: Upload container logs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ${{ matrix.name }}_container_logs
          path: ./${{ env.RADIUS_CONTAINER_LOG_BASE }}

      - name: Collect Terraform recipe publishing logs
        if: always()
        run: |
          mkdir -p recipes/pod-logs
          namespace="radius-test-tf-module-server"
          label="app.kubernetes.io/name=tf-module-server"
          pod_names=($(kubectl get pods -l $label -n $namespace -o jsonpath='{.items[*].metadata.name}'))
          for pod_name in "${pod_names[@]}"; do
            kubectl logs $pod_name -n $namespace > recipes/pod-logs/${pod_name}.txt
          done
          kubectl get events -n $namespace > recipes/pod-logs/events.txt

      - name: Upload Terraform recipe publishing logs
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: ${{ matrix.name }}_recipes-pod-logs
          path: recipes/pod-logs
          if-no-files-found: error

  report-failure:
    if: failure() && github.event_name == 'schedule' && github.repository == 'radius-project/radius' && needs.changes.outputs.only_changed != 'true'
    name: Report test failure
    needs: [changes, build, tests]
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    permissions: {}
    steps:
      - name: Create failure issue for failing scheduled run
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GH_RAD_CI_BOT_PAT }}
          script: |
            github.rest.issues.create({
              ...context.repo,
              title: `Scheduled functional test (noncloud) failed - Run ID: ${context.runId}`,
              labels: ['test-failure'],
              body: `## Bug information \n\nThis issue is automatically generated if the scheduled functional test fails. The Radius functional test operates on a schedule of every 4 hours during weekdays and every 12 hours over the weekend. It's important to understand that the test may fail due to workflow infrastructure issues, like network problems, rather than the flakiness of the test itself. For the further investigation, please visit [here](${process.env.ACTION_LINK}).`
            })
