// ------------------------------------------------------------
// Copyright (c) Microsoft Corporation.
// Licensed under the MIT License.
// ------------------------------------------------------------

package setup

import (
	"os"
	"path/filepath"
	"testing"

	"github.com/project-radius/radius/pkg/cli/output"
	"github.com/stretchr/testify/require"
	"gopkg.in/yaml.v3"
)

//
// <AiDoc: The following comments were generated by OpenAI explaining the code as it existed at the time of this commit>
//	The previous function is creating two files in a temporary directory. The first file is a YAML file called "rad.yaml" 
//	which contains a workspace with an application name. The second file is called "app.bicep" and contains a template. The 
//	function also logs the creation of both files.
//
// </AiDoc: End of OpenAI comments>
func Test_ScaffoldApplication_CreatesBothFiles(t *testing.T) {
	directory := t.TempDir()
	outputSink := &output.MockOutput{}

	err := ScaffoldApplication(outputSink, directory, "cool-application")
	require.NoError(t, err)

	require.FileExists(t, filepath.Join(directory, ".rad", "rad.yaml"))
	require.FileExists(t, filepath.Join(directory, "app.bicep"))

	b, err := os.ReadFile(filepath.Join(directory, ".rad", "rad.yaml"))
	require.NoError(t, err)

	actualYaml := map[string]any{}
	err = yaml.Unmarshal(b, &actualYaml)
	require.NoError(t, err)

	expectedYaml := map[string]any{
		"workspace": map[string]any{
			"application": "cool-application",
		},
	}
	require.Equal(t, expectedYaml, actualYaml)

	b, err = os.ReadFile(filepath.Join(directory, "app.bicep"))
	require.NoError(t, err)
	require.Equal(t, appBicepTemplate, string(b))

	expectedOutput := []any{
		output.LogOutput{
			Format: "Created %q",
			Params: []any{"app.bicep"},
		},
		output.LogOutput{
			Format: "Created %q",
			Params: []any{filepath.Join(".rad", "rad.yaml")},
		},
	}
	require.Equal(t, expectedOutput, outputSink.Writes)
}

//
// <AiDoc: The following comments were generated by OpenAI explaining the code as it existed at the time of this commit>
//	This function is creating a temporary directory, creating a mock output, creating two files in the temporary directory, 
//	and then running the ScaffoldApplication function on the directory. It then checks that the rad.yaml file was created 
//	and that the app.bicep file was not changed, and that the output was as expected.
//
// </AiDoc: End of OpenAI comments>
func Test_ScaffoldApplication_KeepsAppBicepButWritesRadYaml(t *testing.T) {
	directory := t.TempDir()
	outputSink := &output.MockOutput{}

	// Pre-create files
	err := os.Mkdir(filepath.Join(directory, ".rad"), 0755)
	require.NoError(t, err)
	err = os.WriteFile(filepath.Join(directory, ".rad", "rad.yaml"), []byte("something else"), 0644)
	require.NoError(t, err)
	err = os.WriteFile(filepath.Join(directory, "app.bicep"), []byte("something else"), 0644)
	require.NoError(t, err)

	err = ScaffoldApplication(outputSink, directory, "cool-application")
	require.NoError(t, err)

	require.FileExists(t, filepath.Join(directory, ".rad", "rad.yaml"))
	require.FileExists(t, filepath.Join(directory, "app.bicep"))

	b, err := os.ReadFile(filepath.Join(directory, ".rad", "rad.yaml"))
	require.NoError(t, err)

	actualYaml := map[string]any{}
	err = yaml.Unmarshal(b, &actualYaml)
	require.NoError(t, err)

	expectedYaml := map[string]any{
		"workspace": map[string]any{
			"application": "cool-application",
		},
	}
	require.Equal(t, expectedYaml, actualYaml)

	b, err = os.ReadFile(filepath.Join(directory, "app.bicep"))
	require.NoError(t, err)
	require.Equal(t, "something else", string(b))

	expectedOutput := []any{
		output.LogOutput{
			Format: "Created %q",
			Params: []any{filepath.Join(".rad", "rad.yaml")},
		},
	}
	require.Equal(t, expectedOutput, outputSink.Writes)
}
