// ------------------------------------------------------------
// Copyright (c) Microsoft Corporation.
// Licensed under the MIT License.
// ------------------------------------------------------------

package setup

import (
	"context"
	"encoding/json"
	"fmt"
	"net/http"
	"strings"

	"github.com/project-radius/radius/pkg/sdk"
	"github.com/project-radius/radius/pkg/ucp/api/v20220901privatepreview"
)

type ErrUCPResourceGroupCreationFailed struct {
	resp *http.Response
	err  error
}

//
// <AiDoc: The following comments were generated by OpenAI explaining the code as it existed at the time of this commit>
//	This function is creating an error message for when a UCP resource group creation fails. It takes in an error and a 
//	response, and then formats an error message based on whether the response is nil or not.
//
// </AiDoc: End of OpenAI comments>
func (e *ErrUCPResourceGroupCreationFailed) Error() string {
	if e.resp == nil {
		return fmt.Sprintf("failed to create UCP resourceGroup: %s", e.err)
	}

	return fmt.Sprintf("request to create UCP resourceGroup failed with status: %d, response: %+v", e.resp.StatusCode, e.resp)
}

//
// <AiDoc: The following comments were generated by OpenAI explaining the code as it existed at the time of this commit>
//	This function is checking if the given error is of type ErrUCPResourceGroupCreationFailed and returning a boolean value 
//	indicating whether it is or not.
//
// </AiDoc: End of OpenAI comments>
func (e *ErrUCPResourceGroupCreationFailed) Is(target error) bool {
	_, ok := target.(*ErrUCPResourceGroupCreationFailed)
	return ok
}

// TODO remove this when envInit is removed. DO NOT add new uses of this function. Use the generated client.
//
// <AiDoc: The following comments were generated by OpenAI explaining the code as it existed at the time of this commit>
//	This function creates a resource group in two different planes, the radius plane and the deployments plane, with the 
//	given name. It returns the ID of the resource group created in the radius plane.
//
// </AiDoc: End of OpenAI comments>
func CreateWorkspaceResourceGroup(ctx context.Context, connection sdk.Connection, name string) (string, error) {
	id, err := createUCPResourceGroup(ctx, connection, name, "/planes/radius/local")
	if err != nil {
		return "", err
	}

	// TODO: we TEMPORARILY create a resource group in the deployments plane because the deployments RP requires it.
	// We'll remove this in the future.
	_, err = createUCPResourceGroup(ctx, connection, name, "/planes/deployments/local")
	if err != nil {
		return "", err
	}

	return id, nil
}

//
// <AiDoc: The following comments were generated by OpenAI explaining the code as it existed at the time of this commit>
//	This function creates a resource group in the Azure Universal Control Plane (UCP) using the provided connection, 
//	resource group name, and plane. It sends a PUT request to the UCP endpoint with the resource group name and a location 
//	of "global" in the body of the request. If the request is successful, it will return the ID of the newly created 
//	resource group.
//
// </AiDoc: End of OpenAI comments>
func createUCPResourceGroup(ctx context.Context, connection sdk.Connection, resourceGroupName string, plane string) (string, error) {
	createRgRequest, err := http.NewRequest(
		http.MethodPut,
		fmt.Sprintf("%s%s/resourceGroups/%s?api-version=%s", connection.Endpoint(), plane, resourceGroupName, v20220901privatepreview.Version),
		strings.NewReader(`{
			"location": "global"
		}`))

	if err != nil {
		return "", &ErrUCPResourceGroupCreationFailed{nil, err}
	}
	createRgRequest = createRgRequest.WithContext(ctx)
	createRgRequest.Header.Add("Content-Type", "application/json")

	resp, err := connection.Client().Do(createRgRequest)
	if err != nil || (resp.StatusCode != http.StatusCreated && resp.StatusCode != http.StatusOK) {
		return "", &ErrUCPResourceGroupCreationFailed{resp, err}
	}

	defer resp.Body.Close()
	var jsonBody map[string]any
	if json.NewDecoder(resp.Body).Decode(&jsonBody) != nil {
		return "", nil
	}

	return jsonBody["id"].(string), nil
}
