// ------------------------------------------------------------
// Copyright (c) Microsoft Corporation.
// Licensed under the MIT License.
// ------------------------------------------------------------

package output

import (
	"bytes"
	"strings"
	"testing"

	"github.com/stretchr/testify/require"
)

type tableInput struct {
	Size   string
	IsCool bool
}

var tableInputOptions = FormatterOptions{
	// Note: We're not testing the behavior of JSONPath in detail since we don't implement that, just the E2E.
	Columns: []Column{
		{
			Heading:  "Size",
			JSONPath: "{ .Size }",
		},
		{
			Heading:  "Coolness",
			JSONPath: "{ .IsCool }",
		},
		{
			Heading:  "Unknown",
			JSONPath: "{ .FieldDoesNotExist }",
		},
		{
			Heading:  "Static",
			JSONPath: "Some-Value",
		},
		{
			Heading:     "Lowered",
			JSONPath:    "Some-Value",
			Transformer: strings.ToLower,
		},
	},
}

//
// <AiDoc: The following comments were generated by OpenAI explaining the code as it existed at the time of this commit>
//	This function is testing a TableFormatter object to ensure that it returns an error when no columns are defined. It does
//	 this by creating a struct with no fields, and then passing it to the TableFormatter object. If no columns are defined, 
//	the TableFormatter should return an error.
//
// </AiDoc: End of OpenAI comments>
func Test_Table_NoColumns(t *testing.T) {
	obj := struct{}{}

	formatter := &TableFormatter{}

	buffer := &bytes.Buffer{}
	err := formatter.Format(obj, buffer, FormatterOptions{})
	require.Error(t, err)
	require.Equal(t, "no columns were defined, table format is not supported for this command", err.Error())
}

//
// <AiDoc: The following comments were generated by OpenAI explaining the code as it existed at the time of this commit>
//	This function is testing a TableFormatter object by creating a tableInput object with two properties, Size and IsCool, 
//	and then formatting it using the TableFormatter object. It then checks that the output is as expected.
//
// </AiDoc: End of OpenAI comments>
func Test_Table_Scalar(t *testing.T) {
	obj := tableInput{
		Size:   "mega",
		IsCool: true,
	}

	formatter := &TableFormatter{}

	buffer := &bytes.Buffer{}
	err := formatter.Format(obj, buffer, tableInputOptions)
	require.NoError(t, err)

	expected := `Size      Coolness  Unknown   Static      Lowered
mega      true                Some-Value  some-value
`
	require.Equal(t, expected, buffer.String())
}

//
// <AiDoc: The following comments were generated by OpenAI explaining the code as it existed at the time of this commit>
//	This function is creating a slice of two tableInput objects, and then using a TableFormatter to format the objects into 
//	a table. The table will have five columns, labeled Size, Coolness, Unknown, Static, and Lowered. The first column will 
//	contain the Size values from the objects, the second column will contain the IsCool values from the objects, the third 
//	column will contain the value "Some-Value" for both objects, the fourth column will contain the value "some-value" for 
//	both objects, and the fifth column will be empty.
//
// </AiDoc: End of OpenAI comments>
func Test_Table_Slice(t *testing.T) {
	obj := []any{
		tableInput{
			Size:   "mega",
			IsCool: true,
		},
		tableInput{
			Size:   "medium",
			IsCool: false,
		},
	}

	formatter := &TableFormatter{}

	buffer := &bytes.Buffer{}
	err := formatter.Format(obj, buffer, tableInputOptions)
	require.NoError(t, err)

	expected := `Size      Coolness  Unknown   Static      Lowered
mega      true                Some-Value  some-value
medium    false               Some-Value  some-value
`
	require.Equal(t, expected, buffer.String())
}

//
// <AiDoc: The following comments were generated by OpenAI explaining the code as it existed at the time of this commit>
//	The previous function is testing the convertToStruct function. It is creating a struct and a slice of convertInputs 
//	which contain different types of inputs. It then runs a test for each input in the slice, checking if the 
//	convertToStruct function returns the expected result and if it returns an error when it should.
//
// </AiDoc: End of OpenAI comments>
func Test_convertToStruct(t *testing.T) {
	aStruct := tableInput{
		Size: "medium",
	}
	inputs := []convertInput{
		{
			Name:    "string",
			Input:   "test",
			Success: false,
		},
		{
			Name:    "nil",
			Input:   nil,
			Success: false,
		},
		{
			Name:    "nil pointer",
			Input:   (*tableInput)(nil),
			Success: false,
		},
		{
			Name:    "struct",
			Input:   aStruct,
			Success: true,
			Expected: []any{
				aStruct,
			},
		},
		{
			Name:    "struct pointer",
			Input:   &aStruct,
			Success: true,
			Expected: []any{
				aStruct,
			},
		},
		{
			Name: "slice",
			Input: []any{
				aStruct, &aStruct, "test", []any{},
			},
			Success: true,
			Expected: []any{
				aStruct, &aStruct, "test", []any{},
			},
		},
	}

	for _, input := range inputs {
		t.Run(input.Name, func(t *testing.T) {
			actual, err := convertToSlice(input.Input)
			if input.Success {
				require.NoError(t, err)
				require.Equal(t, input.Expected, actual)
			} else {
				require.Error(t, err)
			}
		})
	}
}

type convertInput struct {
	Name     string
	Input    any
	Success  bool
	Expected []any
}
