// Package output provides output generation for discovery results.
package output

import (
	"bytes"
	"fmt"
	"io"
	"os"
	"path/filepath"
	"strings"
	"text/template"
	"time"

	"github.com/radius-project/radius/pkg/discovery/dtypes"
)

// MarkdownGenerator generates discovery.md output.
type MarkdownGenerator struct {
	tmpl *template.Template
}

// NewMarkdownGenerator creates a new Markdown generator.
func NewMarkdownGenerator() (*MarkdownGenerator, error) {
	tmpl, err := template.New("discovery.md").Funcs(templateFuncs).Parse(discoveryTemplate)
	if err != nil {
		return nil, fmt.Errorf("parsing template: %w", err)
	}
	return &MarkdownGenerator{tmpl: tmpl}, nil
}

var templateFuncs = template.FuncMap{
	"upper":      strings.ToUpper,
	"lower":      strings.ToLower,
	"title":      strings.Title, //nolint:staticcheck
	"join":       strings.Join,
	"percentage": func(f float64) string { return fmt.Sprintf("%.0f%%", f*100) },
	"formatTime": func(t time.Time) string { return t.Format("2006-01-02 15:04:05") },
	"basename":   filepath.Base,
	"iacResourceCount": func(sources []dtypes.PracticeSource) int {
		total := 0
		for _, s := range sources {
			total += len(s.Resources)
		}
		return total
	},
	"iacTypes": func(sources []dtypes.PracticeSource) string {
		typeSet := make(map[string]bool)
		for _, s := range sources {
			typeSet[string(s.Type)] = true
		}
		if len(typeSet) == 0 {
			return "_None_"
		}
		var types []string
		for t := range typeSet {
			types = append(types, t)
		}
		return strings.Join(types, ", ")
	},
	"iacProviders": func(sources []dtypes.PracticeSource) string {
		// Cloud providers only (exclude utility providers like "random")
		cloudProviders := map[string]bool{
			"azurerm": true, "aws": true, "google": true, "azuread": true,
			"kubernetes": true, "helm": true, "oci": true, "alicloud": true,
			"digitalocean": true, "heroku": true, "vsphere": true,
		}
		providerSet := make(map[string]bool)
		for _, s := range sources {
			for _, p := range s.Providers {
				if cloudProviders[strings.ToLower(p)] {
					providerSet[p] = true
				}
			}
		}
		if len(providerSet) == 0 {
			return "_None detected_"
		}
		var providers []string
		for p := range providerSet {
			providers = append(providers, p)
		}
		return strings.Join(providers, ", ")
	},
}

// Generate writes discovery results to Markdown.
func (g *MarkdownGenerator) Generate(result *dtypes.DiscoveryResult, w io.Writer) error {
	return g.tmpl.Execute(w, result)
}

// GenerateToFile writes discovery results to a file.
func (g *MarkdownGenerator) GenerateToFile(result *dtypes.DiscoveryResult, outputPath string) error {
	// Ensure directory exists
	dir := filepath.Dir(outputPath)
	if err := os.MkdirAll(dir, 0755); err != nil {
		return fmt.Errorf("creating output directory: %w", err)
	}

	var buf bytes.Buffer
	if err := g.Generate(result, &buf); err != nil {
		return fmt.Errorf("generating markdown: %w", err)
	}

	if err := os.WriteFile(outputPath, buf.Bytes(), 0644); err != nil {
		return fmt.Errorf("writing file: %w", err)
	}

	return nil
}

// discoveryTemplate is the Markdown template for discovery.md.
const discoveryTemplate = `# Application Discovery Report

> Generated by ` + "`rad app discover`" + ` on {{ formatTime .AnalyzedAt }}  
> Project: ` + "`{{ .ProjectPath }}`" + ` | Confidence: {{ percentage .Confidence }}

---

## 1. Detected Services

{{ if .Services }}
| Service | Language | Framework | Path | Confidence | Dependencies |
|---------|----------|-----------|------|------------|--------------|
{{ range .Services }}| **{{ .Name }}** | {{ .Language }} | {{ if .Framework }}{{ .Framework }}{{ else }}-{{ end }} | ` + "`{{ .Path }}`" + ` | {{ percentage .Confidence }} | {{ if .DependencyIDs }}{{ join .DependencyIDs ", " }}{{ else }}-{{ end }} |
{{ end }}

### Service Details

{{ range .Services }}
<details>
<summary><strong>{{ .Name }}</strong> ({{ .Language }}{{ if .Framework }}/{{ .Framework }}{{ end }})</summary>

- **Path:** ` + "`{{ .Path }}`" + `
- **Language:** {{ .Language }}
{{ if .Framework }}- **Framework:** {{ .Framework }}{{ end }}
- **Confidence:** {{ percentage .Confidence }}
{{ if .EntryPoint.File }}- **Entry Point:** ` + "`{{ .EntryPoint.File }}`" + ` ({{ .EntryPoint.Type }}){{ end }}
{{ if .EntryPoint.Command }}- **Command:** ` + "`{{ .EntryPoint.Command }}`" + `{{ end }}
{{ if .Dockerfile }}- **Dockerfile:** ` + "`{{ .Dockerfile }}`" + `{{ end }}
{{ if .ExposedPorts }}- **Exposed Ports:** {{ range $i, $p := .ExposedPorts }}{{ if $i }}, {{ end }}{{ $p }}{{ end }}{{ end }}
{{ if .DependencyIDs }}- **Dependencies:** {{ join .DependencyIDs ", " }}{{ end }}

{{ if .Evidence }}**Evidence:**
{{ range .Evidence }}
  - {{ .Type }}: ` + "`{{ .File }}`" + `{{ if .Snippet }} → ` + "`{{ .Snippet }}`" + `{{ end }}
{{ end }}
{{ end }}

</details>
{{ end }}
{{ else }}
_No services detected._
{{ end }}

---

## 2. Detected Dependencies

{{ if .Dependencies }}
| Dependency | Type | Library/Image | Version | Confidence | Used By |
|------------|------|---------------|---------|------------|---------|
{{ range .Dependencies }}| **{{ .ID }}** | {{ .Type }} | ` + "`{{ .Library }}`" + ` | {{ if .Version }}{{ .Version }}{{ else }}- {{ end }} | {{ percentage .Confidence }} | {{ if .UsedBy }}{{ join .UsedBy ", " }}{{ else }}-{{ end }} |
{{ end }}

### Dependency Details

{{ range .Dependencies }}
<details>
<summary><strong>{{ .ID }}</strong> ({{ .Type }})</summary>

- **Library:** ` + "`{{ .Library }}`" + `{{ if .Version }} v{{ .Version }}{{ end }}
{{ if .ConnectionEnv }}- **Connection Env:** ` + "`{{ .ConnectionEnv }}`" + `{{ end }}
{{ if .DefaultPort }}- **Default Port:** {{ .DefaultPort }}{{ end }}
{{ if .UsedBy }}- **Used By:** {{ join .UsedBy ", " }}{{ end }}

**Evidence:**
{{ range .Evidence }}
  - {{ .Type }}: ` + "`{{ .File }}`" + ` → ` + "`{{ .Snippet }}`" + `
{{ end }}

</details>
{{ end }}
{{ else }}
_No infrastructure dependencies detected._
{{ end }}

---

## 3. Existing Infrastructure as Code

{{ if .Practices.ExtractedFrom }}
### Summary

| Metric | Value |
|--------|-------|
| **IaC Type** | {{ iacTypes .Practices.ExtractedFrom }} |
| **Files Analyzed** | {{ len .Practices.ExtractedFrom }} |
| **Total Resources** | {{ iacResourceCount .Practices.ExtractedFrom }} |
| **Cloud Providers** | {{ iacProviders .Practices.ExtractedFrom }} |

### Resources

| File | Resources |
|------|-----------|
{{ range .Practices.ExtractedFrom }}| ` + "`{{ .FilePath | basename }}`" + ` | {{ if .Resources }}{{ len .Resources }}{{ else }}0{{ end }} |
{{ end }}

{{ range .Practices.ExtractedFrom }}{{ if .Resources }}
**{{ .FilePath | basename }}:**
{{ range .Resources }}- ` + "`{{ .Type }}`" + ` ({{ .Name }})
{{ end }}{{ end }}{{ end }}

These files were analyzed to extract infrastructure conventions and will inform the generated ` + "`app.bicep`" + `.
{{ else }}
_No existing IaC files detected._

To enable IaC analysis, add:
- **Terraform:** ` + "`.tf`" + ` files in project root or ` + "`/infra`" + `
- **Bicep:** ` + "`.bicep`" + ` files in project root or ` + "`/infra`" + `
- **Config:** ` + "`.radius/team-practices.yaml`" + `
{{ end }}

---

## 4. Infrastructure Practices

{{ if .Practices.ExtractedFrom }}
| Practice | Value |
|----------|-------|
| **Naming Convention** | {{ if .Practices.NamingConvention.Pattern }}` + "`{{ .Practices.NamingConvention.Pattern }}`" + `{{ else }}_Not detected_{{ end }} |
| **Environment** | {{ if .Practices.Environment }}{{ .Practices.Environment }}{{ else }}_Not detected_{{ end }} |
| **Region** | {{ if .Practices.Region }}{{ .Practices.Region }}{{ else }}_Not detected_{{ end }} |
| **Default Tier** | {{ if .Practices.DefaultTier }}{{ .Practices.DefaultTier }}{{ else }}_Not detected_{{ end }} |
| **Encryption** | {{ if .Practices.EncryptionEnabled }}✅ Enabled{{ else }}❌ Not enabled{{ end }} |
| **Private Networking** | {{ if .Practices.PrivateNetworking }}✅ Enabled{{ else }}❌ Not enabled{{ end }} |

{{ if .Practices.Tags }}
**Resource Tags:**
{{ range $k, $v := .Practices.Tags }}
- ` + "`{{ $k }}`" + `: {{ $v }}
{{ end }}
{{ end }}

{{ if .Practices.NamingConvention.Examples }}
**Naming Examples:** {{ range $i, $e := .Practices.NamingConvention.Examples }}{{ if $i }}, {{ end }}` + "`{{ $e }}`" + `{{ end }}
{{ end }}
{{ else }}
_No infrastructure practices detected from IaC files._
{{ end }}

---

## Summary

| Metric | Count |
|--------|-------|
| Dependencies | {{ len .Dependencies }} |
| Services | {{ len .Services }} |
| IaC Files | {{ if .Practices.ExtractedFrom }}{{ len .Practices.ExtractedFrom }}{{ else }}0{{ end }} |
| Resource Mappings | {{ len .ResourceTypes }} |
| Warnings | {{ len .Warnings }} |

{{ if .Services }}
**Detected Services:** {{ range $i, $s := .Services }}{{ if $i }}, {{ end }}{{ $s.Name }} ({{ $s.Language }}){{ end }}
{{ end }}

{{ if .Warnings }}
### ⚠️ Warnings
{{ range .Warnings }}
- **{{ .Code }}**: {{ .Message }}
{{ end }}
{{ end }}

---

## Next Steps

1. Review the detected dependencies above
2. Run ` + "`rad app generate`" + ` to create your app.bicep
3. Deploy with ` + "`rad deploy ./radius/app.bicep`" + `

For more information, see [Radius Documentation](https://docs.radapp.io).
`
